\chapter{Examples}
\label{chap:examples}
\section{Introduction}
\label{sect:examples_introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------One-dimensional advection-------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{One dimensional advection}
\label{sect:oned_advection}
\subsection{Overview}
In this test example a very simple one-dimensional problem is 
studied: the advection of an inital ``top hat'' distribution 
of a tracer (see figure \ref{fig:top_hat_ic}). Since this test runs in a  
short time, it allows users to play around with various
settings, e.g. spatial discretisation options, adaptivity 
and interpolation settings, etc., and quickly see the results
of their changes. The challenge in this example is get an accurate
answer while keeping the solution conservative and bounded.

\begin{figure}
  \centering
  \subfigure[Initial condition of the top hat tracer.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_ic}} 
    \label{fig:top_hat_ic}
  \subfigure[Numerical solution using Continuous Galerkin.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_cg}} 
    \label{fig:top_hat_cg} \\
  \subfigure[Numerical solution using Discontinuous Galerkin.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_dg}}
    \label{fig:top_hat_dg}
  \subfigure[Numerical solution using Control Volumes.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_cv}}
    \label{fig:top_hat_cv}
  \caption{Initial condition and numerical solutions after $100~s$, for the 1D top hat tracer advection problem.}
\end{figure}

\subsection{Configuration}
The domain is the one-dimensional interval $[0,3]$. The initial 
mesh with $\Delta x=0.025~m$ is created using the ``interval'' 
script. The initial ``top hat'' distribution (figure \ref{fig:top_hat_ic}) is 
prescribed by a python function. The advective velocity is 
prescribed as a constant of $u=0.01~ms^{-1}$. Output is created
in the form of a .vtu-file every second of simulation time
and a .stat file. The total simulation time is $500~s$. 
The ``top-hat'' does not reach the boundary in this time, so that
boundary conditions play no role in this example.

\subsubsection{Spatial discretisation}
This example provides three basic configurations, corresponding to
the three main discretisation types of the advection-diffusion equation
available in fluidity:
\begin{itemize}
\item {\bf Continuous Galerkin (CG)}, section \ref{sect:ND_advection_diffusion_CG}
This is the most basic finite-element discretisation that is simple 
and fairly efficient. It is however not very good for advection problems
of tracers with sharp discontinuities. In the example configuration
SUPG stabilisation is applied to improve the results.
\item {\bf Discontinuous Galerkin (DG)}, section \ref{sec:NM_DG_advection}
This is a popular method for advection problems, in particular 
for non-smooth tracer solutions. To prevent under and overshoots
slope limiters may still be necessary near discontinuities, and are
therefore used in this example.
\item {\bf Control Volume (CV)}
This is a simple and efficient method, that however in some cases 
can be fairly diffusive. Its accuracy is determined by the choice 
of interpolation at the control volume faces - a ``FiniteElement''
interpolation is used here in combination with a ``Sweby'' slope 
limiter to keep the solution bounded. 
\end{itemize}

\subsubsection{Adaptivity and interpolation options}
The mesh adaptivity procedure is guided by the metric that is based on
the (interpolation) error bounds set for the tracer field. Since at 
the front and back of the top hat solution the derivatives 
become very large, this would lead to nearly infinite resolution at these
discontinuties. A ``MinimumEdgeLength'' therefore needs to be set, to prevent
such very small elements which would produce very high CFL numbers.

This example uses ``adapt\_at\_first\_timestep'', so that a suitably
adapted mesh is used from the first time step. The initial condition
will be directly prescribed on this first adapted mesh and not interpolated
from the user provided initial mesh.

Since we want to exactly conserve the amount of tracer in this example
a galerkin projection based interpolation scheme is used to interpolate
between subsequently adapted meshes. To keep the solution bounded the
``minimally dissipative'' bounding procedure is used (only available for CG and DG).

\subsubsection{Time stepping}
Although this example uses a stable implicit time integration scheme (Crank Nicolson),
it is generally desirable for advection problems to control the CFL number. This is done
via the adaptive time stepping scheme which dynamically changes the time 
step based on a desired CFL number - set to 0.5 in the example configurations. Because the 
example uses a constant velocity, the time step is only determined by the smallest 
element size which may vary due to the adaptivity process, although it is here
limited by the chosen ``MinimumEdgeLength''. Since we use an adapted mesh from the first 
timestep we need the option \option{at\_first\_timestep} to use a corresponding 
adaptive initial timestep.

\subsection{Results}
To view the results of this example in paraview, the following steps
must be taken:
\begin{itemize}
\item Open up the series of vtus in the normal way.
\item Add the \texttt{Warp (scalar)} filter. Choose a normal direction of $0,1,0$ and click apply.
\item To visualise the grid points: add the \texttt{Glyph} filter; Choose \texttt{Glyph Type} \texttt{Sphere},
select the \texttt{Edit} checkbox next to \texttt{Set Scale Factor} and choose a value of 0.02; Click apply.
\end{itemize}

Alternatively the results can be plotted using python. An example python script using pylab and the 
vtktools python module, is provided with this example. The vtktools module is located in 
\texttt{\fluiditysourcepath/python/}; this path needs to be added to the \texttt{PYTHONPATH} environment
variable.

As can be seen in the numerical result using the CG method leads, to over and 
undershoots in the solution. The DG result seems to encur no noticable bounds
violation. The Control Volumes solution is perfectly bounded, but rather diffusive. Note that in each of 
these cases the initial mesh resolution has changed and is still focussed near the jumps in the solution.

A more precise analysis of the boundedness and conservation properties of the numerical solution, can be
derived from the data in the .stat file, which can be visualised using the statplot program 
(section \ref{sect:statplot}). As can be seen in figure \ref{fig:top_hat_cg_conservation} the tracer
concentration in the CG case is not completely conserved. 
The CG and CV solutions show perfect conservation (to machine precision). The minimum 
and maximum (figure \ref{fig:top_hat_dg_max}) tracer concentration of the
DG solution show the occurence of overshoots with the same frequency as the adapts. This is caused by the
fact that the Galerkin projection used to interpolate during the mesh adaptation stage is not 
bounded. The slope limiting applied in the DG advection algorithm however filters these overshoots 
out again. The Galerkin projection used for CG and CV is combined with a bounding procedure, so 
that interpolation doesn't add additional bounds violations. In the case of CG however the numerical 
scheme itself is not bounded.

\begin{figure}
  \centering
  \subfigure[Tracer conservation in the Continuous Galerkin solution.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_cg_conservation}} 
    \label{fig:top_hat_cg_conservation}
  \subfigure[Maximum tracer bound in the Discontinuous Galerkin solution.]{\fig[width=0.47\textwidth]{examples_images/top_hat/top_hat_dg_max}} 
    \label{fig:top_hat_dg_max}
  \caption{Conservation and bounds checking using statplot.}
\end{figure}

\subsection{Exercises}
\begin{itemize}
\item For the Continuous Galerkin example see what the effect is of the SUPG stabilisation by
changing the option \option{\ldots/spatial\_discretisation/continuous\_galerkin/stabilisation/}
\option{streamline\_upwind\_petrov\_galerkin} to \option{no\_stabilisation}
\item Change the resolution of the adapted meshes by changing \\
\option{adaptivity\_options/absolute\_measure/scalar\_field::InterpolationErrorBound}
under \option{\ldots/scalar\_field::Tracer/prognostic/} and see what the effect
of the option
\option{/mesh\_adaptivity/hr\_adaptivity/enable\_gradation} is.
\item A conservative and bounded CV advection scheme that is less diffusive can be achieved by changing 
the following options:
\begin{itemize}
\item Change \option{\ldots/limit\_face\_value/limiter::Sweby} to \option{limiter::Ultimate}.
\item Under \option{\ldots/temporal\_discretisation}, change theta to 0.0.
\item Under \option{\ldots/temporal\_discretisation/control\_volumes}
remove \\
\option{number\_advection\_iterations} and \option{limit\_theta}, and
add \option{pivot\_theta} with a value of 0.0.
\end{itemize}
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------THE LOCK-EXCHANGE---------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The lock-exchange}
\label{sect:lock_exchange}
\subsection{Overview}
\label{sect:lock_exchange_overview}

The lock-exchange is a classic laboratory-scale fluid dynamics problem, \citep{fannelop_94, huppert_06, simpson_87}. A flat-bottomed tank is separated into two portions by a vertical barrier. One portion, the `lock', is filled with the source fluid. This is of different density to the ambient fluid which fills the other portion. As the barrier is removed, the denser fluid collapses under the lighter. Two gravity currents form and propagate in opposite directions, one above the other, along the tank. After an initial acceleration, the gravity current fronts travel at a constant speed until the end walls exert an influence or viscous forces begin to dominate, \citep{cantero_07, hartel_99, huppert_80}. At the current front a bulbous head may develop and become taller than the trailing fluid. A shear instability can manifest at the density-interface (hereafter interface) between the two fluids, \citep{turner_73}, and this leads to the formation of Kelvin-Helmholtz billows that enhance mixing.

The lock-exchange has been the subject of many theoretical, experimental and numerical studies, and the front speed (or Froude number) is commonly calculated, making it an excellent diagnostic for verification of \fluidity\, e.g. \citep{benjamin_68, klemp_94, hartel_00}. Furthermore the same physical processes are that are encountered in gravity currents over a range of scales are incorporated. Therefore, the lock-exchange presents a tractable means of studying the processes involved and contributes to our understanding of real-world flows, such as sediment-laden density currents and oceanic overflows, and their impact.

In this example, \fluidity\ is used to simulate a lock-exchange and the following functionality is demonstrated:

\begin{itemize}
\item 2D flow
\item Non-hydrostatic flow
\item Incompressible flow
\item Boussinesq flow
\item Mesh adaptivity

\end{itemize}

\subsection{Configuration}
\label{sect:lock_exchange_configuration}

The domain and physical parameters are set up after \cite{fringer_06} and \cite{ozgokmen_07}, table \ref{tab:le_physical_parameters}. The domain is a 2D rectangular box, $0\leq x \leq 0.8\,$m, $0 \leq z \leq 0.1\,$m. Initially, dense, cold water of $T = -0.5\,^\circ$C fills one half of the domain, $x<0.4\,$m, and light, warm water of $T = 0.5\,^\circ$C fills the other half, $x\geq0.4\,$m, figure \ref{fig:lock_exchange}. At $t=0\,$s, ${\bf u} = {\bf 0}$ everywhere. A no-slip boundary condition is applied along the bottom of the domain, ${\bf u = 0}$ at $z=0$, and a free-slip boundary condition is applied to the top of the domain and the side walls, ${\bf u\cdot\bf n} = 0$ at $z = 0.1\,$m and $x = 0.0,\, 0.8\,$m.

The basic choices for the numerical set-up are outlined in table \ref{tab:le_numerical_configuration}. They comprise a set of standard options for a buoyancy-driven flow such as the lock-exchange. The mesh is adapted to both the velocity and the temperature fields.  

\begin{table}[th]
\centering
\begin{tabular}[h]{l   c  c }  \hline
gravitational acceleration (ms$^{-2}$)			& $g$ 								& $10$  \\
kinematic viscosity (m$^2$s$^{-1}$)			& $\nu$								& $10^{-6}$  \\
thermal diffusivity (m$^2$s$^{-1}$)					& $\kappa$ 					& 0  \\
thermal expansion coefficient ($^\circ$C$^{-1}$)	& $\alpha$ 							& $10^{-3}$ \\ 
domain height (m)					& $H = 2h$							& $0.1$ \\ %\hline \hline
reduced gravity	(ms$^{-2}$)				& $g' = g\frac{\rho_1 - \rho_2}{\rho_0} = -g\alpha (T_1 - T_2)$	& $10^{-2}$  \\
buoyancy velocity					& $u_b = \sqrt{g'H}$ 						& $\sqrt{10^{-3}}$ \\
Grashof number						& $Gr = \left( \frac{h \sqrt{g'h}}{\nu} \right)^2$ 		& $1.25 \times 10^{6}$\\ \hline
\end{tabular}
\caption{Physical parameters for the lock-exchange set-up.}
\label{tab:le_physical_parameters}
\end{table}

\begin{table}[th]
\centering
\begin{tabular}[h]{lll}  \hline
Numerical component                           & Configuration                   & Section\\ \hline
Geometry                                      & from triangle file, via gmsh    & \ref{sect:triangle_format}, \ref{sect:meshing_tools_non_fluidity_gmsh}\\
Time step                                     & 0.025\,s                        & \\
Time loop                                     & 2 non-linear Picard iterations  & \ref{sect:ND_time_loop} \\
Equation of state                             & linear                          & \ref{sect:equation_of_state} \\
Momentum and Pressure spatial discretisation  & \Poo                            & \ref{Sect:ND_momentum_equation}, \ref{Sect:ND_pressure_equation}, \ref{sect:configuring_fluidity_continuous_galerkin}, \ref{sect:configuring_fluidity_pressure} \\
Momentum temporal discretisation              & $\theta = 0.5$ (Crank-Nicholson)  & \ref{sect:ND_time_theta_scheme}, \ref{sect:configuring_fluidity_temporal_discretisation} \\
                                              & non-linear relaxation term $=0.5$ & \ref{sect:relax} \\
Temperature advection                         & advection-diffusion equation    & \ref{Sect:MP-AdvdifEqn} \\
                                              & control volumes                 & \ref{Sect:CVs} \\
Temperature temporal discretisation           & $\theta = 0.5$ (Crank-Nicholson)& \ref{sect:ND_time_theta_scheme}, \ref{sect:configuring_fluidity_temporal_discretisation} \\
                                              & advection iterations, limit theta & ??? \\\hline
\end{tabular}
\caption{Numerical configuration for the lock-exchange}
\label{tab:le_numerical_configuration}
\end{table}

\subsection{Results} 
\label{sect:lock_exchange_results}

The expected dynamics of a lock-exchange flow are observed, figure \ref{fig:lock_exchange}: two gravity currents propagate in opposite directions with the foremost point of the no-slip front raised above the lower boundary. Kelvin-Helmholtz billows form at the interface leading to mixing of the two fluids which would not be observed with a hydrostatic formulation. The mesh adapts well, increasing the resolution around the interface and Kelvin-Helmholtz billows with anisotropic elements. Similar images can be generated by visualising the vtu files using Paraview or Mayavi2, see the \href{http://amcg-www.ese.ic.ac.uk/}{AMCG website}\ for more information.

Two diagnostics are considered. First the Froude number, $Fr = U/u_b$, is the ratio of speed, $U$, to the the buoyancy velocity, table \ref{tab:le_physical_parameters} is calculated. The speed with which the no-slip and free-slip fronts propagate along the domain, $U_{ns}$ and $U_{fs}$, are calculated from the model output and are used to give the corresponding no-slip and free-slip Froude numbers, $Fr_{ns}$ and $Fr_{fs}$, figure \ref{fig:lock_exchange_Fr}. For this basic set up the values are comparable to but generally smaller than previously published values, table \ref{tab:lock_exchange_Fr_comparison}. Spatially varying the horizontal velocity adaptivity settings as suggested in the Exercises, section \ref{sect:le_exercises}, can increase the Froude number, showing good agreement between the \fluidity\ values and previously published values. The second diagnostic, the ``domain fraction'', gives an illustration of the mixing taking place, \ref{fig:lock_exchange_mixing}. The temperature ($T$) range is divided into three classes: $T<-0.4$, $-0.4<T<0.4$ and $0.4<T$. For each class the fraction of fluid in the domain that has temperature within the given range gives the domain fraction. The class with range $-0.4<T<0.4$ is considered representative of the mixed fluid. As the simulation progresses, the amount of mixed fluid increases, more rapidly at first as Kelvin-Helmholtz billows form and just after the fronts hit the end wall. Later, as the dynamics become less turbulent and the fluid oscillates back and forth in the tank the mixing is less vigorous. The increase in mixed fluid is compensated for by a decrease in non-mixed fluid.

\begin{figure}[ht]
  \centering
  % For some reason tex4ht doesn't like these images.
  \onlypdf{
  \subfigure[$t = 0\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_0_T}}
  \subfigure[$t = 0\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_0_mesh_nice}} \\
  \subfigure[$t = 12.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_10_T}}
  \subfigure[$t = 12.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_10_mesh}} \\
  \subfigure[$t = 37.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_30_T}}
  \subfigure[$t =
  37.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_30_mesh}}
  }
  \caption{Lock-exchange temperature distribution (colour) with meshes, over time ($t$)}
  \label{fig:lock_exchange}
\end{figure}

\begin{figure}[ht]
  \centering
  \fig[width=1.0\textwidth, clip=True, trim = 32.5mm 20mm 32.5mm 15mm]{./examples_images/lock_exchange/front_speed}
  \caption{Distance along the domain ($X$) and Froude number ($Fr$) for the no-slip and free-slip fronts in the lock-exchange.}
  \label{fig:lock_exchange_Fr}
\end{figure}

\begin{table}[th]
\centering
\begin{tabular}{|c|l|c|c|c|} \hline
& Reference 					& $Gr$ 			& no-slip $Fr$ 	& free-slip $Fr$	\\ [0.1ex] \hline
& Adaptive 1 (\fluidity)			& $1.25 \times 10^{6}$	& 0.381	        & 0.457			\\ [0.1ex]
& Adaptive 2 (\fluidity)			& $1.25 \times 10^{6}$	& 0.417	        & 0.482			\\ [0.1ex]\hline
\multirow{4}{*}{\begin{sideways}\parbox{18mm}{numerical}\end{sideways}} &\cite{hartel_00}, 2D	& $1.25 \times 10^{6}$	& 0.406		& 0.477			\\ [0.1ex]
& \cite{fringer_06}, 2D		                & $1.25 \times 10^{6}$ 	& 0.397 	& 0.428 		\\ [0.1ex]
& \cite{cantero_07}, 3D	                        & $1.50 \times 10^{6}$	& 0.407		& 			\\ [0.1ex]
& \cite{elias_08}, 3D		                & $1.50 \times 10^{6}$	& 0.409		&			\\ [0.1ex] \hline
\multirow{4}{*}{\begin{sideways}\parbox{19.5mm}{experiment}\end{sideways}}& \cite{keulegan_57} & $7.16 \times 10^{7}$ & 0.440&	\\ [0.1ex]
& \cite{britter_78} 	                        & $6.3 \times 10^{7}$	& 	 	& 0.518		 	\\ [0.1ex]
& \cite{simpson_79}                             & $4.8 \times 10^{6}$   & 0.432	        &	 		\\ [0.1ex]
& \cite{shin_04}			        & $>5 \times 10^5$	& 0.464		&			\\ [0.1ex] \hline
\multirow{2}{*}{\begin{sideways}\parbox{11.5mm}{theory}\end{sideways}} & \cite{benjamin_68} &	inviscid	&  & 0.5	\\[0.1ex]
& \cite{klemp_94} 		                &	inviscid	& 		& 0.527			\\ [1.0ex]\hline
\end{tabular}
\caption{Comparison of \fluidity\ Froude numbers with previously published results. \newline Adaptive 1: basic set up as described \newline Adaptive 2: setup with spatially varying interpolation error for the horizontal velocity as suggested in the Exercises, section \ref{sect:le_exercises}.}
\label{tab:lock_exchange_Fr_comparison}
\end{table} 

\begin{figure}[ht]
  \centering
  \fig[width=0.6\textwidth, clip=True, trim = 32.5mm 20mm 32.5mm 20mm]{./examples_images/lock_exchange/mixing}
  \caption{Time evolution of fraction of domain that contains fluid in three temperature classes.}
  \label{fig:lock_exchange_mixing}
\end{figure}

\subsection{Exercises}
\label{sect:le_exercises}
To explore the functionality of \fluidity, the following variations on this example would be constructive learning exercises:
\begin{itemize}
\item Run from the checkpoint to look at the mixing later in the simulation, section \ref{sect:configuring_fluidity_checkpointing}
\item In the adaptivity settings include a spatially varying interpolation error for the horizontal velocity and compare Froude numbers (python can be found in the comment section for the velocity adaptivity settings), section \ref{sect:configuring_fluidity_error_metric}
\item Change the frequency of the adapt, section \ref{sect:configuring_fluidity_adaptivity_options}
\item Turn on metric advection, section \ref{sect:configuring_fluidity_metric_advection}
\item Change the diffusivity and viscosity values
\item Run with a fixed mesh (note this will require making a new input mesh), sections \ref{sect:triangle_format}, \ref{sect:meshing_tools_non_fluidity_gmsh}
\item Try adding some detectors to visualise the particle trajectories, section \ref{sect:diagnostics_detectors} or \newline cf. \option{\ldots/fluidity-longtests/lock\_exchange\_2d\_}
\end{itemize}
Note to compare Froude numbers and mixing between different runs the remember to copy the images otherwise they will be overwritten.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------LID DRIVEN CAVITY---------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Lid-driven cavity}
\label{sect:lid_driven_cavity}

\subsection{Overview}
The lid-driven cavity is a problem that is often used as part of the verification procedure for
CFD codes. The geometry and boundary conditions are simple to prescribe and in
two dimensions there are a number of highly accurate numerical benchmark solutions
available for a wide range of Reynolds numbers \citep{botella1998,erturk2005,bruneau2006}. 
Here the two-dimensional problem at a Reynolds number of 1000 is given as an example.

\subsection{Configuration}
The problem domain is $(x,y) \in [0,1]^2$ and this is represented by an unstructured triangluar mesh
of approximately uniform resolution. To enable convergence analysis a sequence of meshes are considered
with spacing of $h=1/2^n$, $n=4,5,6,7$. The two-dimensional incompressible Navier-Stokes equations are
considered with unit density.

No-slip velocity boundary conditions are imposed on the boundaries $x=0,1$ and $y=0$, 
and the prescribed velocity $u=1$, $v=0$ are set on the boundary $y=1$ (the `lid'). 

Here the problem is initialised with a zero velocity field and the solution
allowed to converge to steady state via time-stepping. The steady state convergence criterion is
that in the infinity norm the velocity varies by less that $10^{-6}$ between time levels.

The time step is constant between all runs, $\Delta t = 0.05$, and data is dumped to disk every
1.0 time units (20 time steps). The Crank-Nicolson $(\theta=0.5)$ discretisation is used in time. 
A \Poo Galerkin method is used for the discretisation of velocity and pressure, with no stabilisation
of velocity. Based on a domain size of $L=1.0$ and a velocity scale taken from the lid $(U=1.0)$, to achive
a Reynolds number of 1000 viscosity is taken to be isotropic with a value of $\nu=0.001$.

 

\begin{figure}
\centering
\subfigure{
\includegraphics[width=7cm,clip]{examples_images/driven_cavity_2d/driven_cavity_streamfunction.png}}
\subfigure{
\includegraphics[width=7cm,clip]{examples_images/driven_cavity_2d/driven_cavity_vorticity.png}}
\caption{Diagnostic fields from the lid-driven cavity problem at steady state at $1/128$ resolution.
Left: the streamfunction. Right: the vorticity. The contour levels are taken from those given by \cite{botella1998} in their tables
7 and 8.}
\label{fig:driven_cavity1}
\end{figure}


\subsection{Results}
Plots of the streamfunction and vorticity from the $h=1/128$ simulation are shown in figure \ref{fig:driven_cavity1}.
Observe the good qualititative agreement with \citep{botella1998,erturk2005,bruneau2006}. 
For a quantitative comaprison we take advantage of the tabulated benchmark data available in these papers.
Only a subset of these are computed: the $u$ velocity at a series of points along the line $x=0.5$ and the
$v$ velocity at a series of points along the line $y=0.5$ from \citep{erturk2005}, the same quantities at
different points along the same lines as well as the pressure along both the $x=0.5$ and $y=0.5$ lines from 
\citep{botella1998}, and the kinetic energy and the minimum streamfunction value from \citep{bruneau2006}.
The RMS difference in the case of the first six sets of benchmark data are taken with values extracted from 
the numerical solution, and the absolute difference taken in the final two. These eight error values are
defined as error1, \ldots error8 respectively and and plotted for the four mesh resolutions in figure 
\ref{fig:driven_cavity2}.
Second order spatial convergence can clearly be seen.
Adaptive refinement is not particularly advantageous for the problem at this reasonably low Reynolds number, but
yields significant improvements in efficiency at higher Reynolds number where boundary layers and
recirculating eddies are more dynamic, anisotropic and smaller in size compared to the entire domain.

\begin{figure}
\centering
\includegraphics[width=10cm,clip]{examples_images/driven_cavity_2d/driven_cavity_error_plot.png}
\caption{Convergence of the eight error metrics computed for the lid-driven cavity problem with mesh spacing. The eight
metrics are described in the text.}
\label{fig:driven_cavity2}
\end{figure}

\subsection{Exercises}
\begin{enumerate}
\item Examine the way that the $u=1$ lid condition is applied in the flml file. Why has it not been set as simply a constant?
Try changing it to a constant and see what happens to the errors that you achieve. [Hint: some people consider to "regularised" 
lid-driven cavity problem, try finding some papers that discuss this, try updating the boundary condition so it matches the 
regularised problem and compare to benchmark data if you can find it].
\item The references given above include data from other Reynolds numbers. Try updating the problem set-up and the python which computes
the errors for a higher Reynolds number.
\item Try switching on mesh adaptivity (you will need to ensure that you have compiled your \fluidity executable with 2D-adaptivity enabled. 
Test adapting based on different metrics, e.g. try weighting $u$, $v$ and $p$
differently and see what meshes you get. Try varying these weights as well as the maximum and minimum allowed element
sizes to see how they affect each other and the mesh that results. Can you get a metric that results in a lower
error for the same number of nodes compared to the fixed mesh [Hint: it may be easier to achieve this at higher Reynolds numbers].
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------BACKWARD FACING STEP------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Backward facing step}
\label{sect:backward_facing_step}


\subsection{Overview}
The backward-facing step is a classical CFD example and one of the most frequently selected
problems for simulating the separation and reattachment of turbulent flows.
It is also often used as a test problem for validating and benchmarking numerical codes.
At high Reynolds numbers and in three spatial dimensions the problem has substantial
computing requirements, this makes it an ideal HPC benchmark problem for use here.
In the context of ocean modelling flow separation is important
in large scale western boundary currents such as the Gulf Stream.

Accurate experimental results for a wide range of flow regimes exist
in 2D and 3D
(e.g. see \cite{armaly1983}) and the problem has several important flow
characteristics, such as the downstream length at which the flow reattaches
with the bottom of the domain. Results from \fluidity\ simulations at Reynolds number 150
are presented here.


\subsection{Configuration}
\subsubsection{Geometry: 3D}
A schematic of the domain is shown in figure \ref{Fig:Schematic3d}.
An inflow is imposed at the left hand boundary and encounters a step
down in the geometry. The region directly downstream of the step is
of particular interest in this problem. An outflow boundary is located at the
right hand end of the geometry.

Please note, this 3D example is intended to be run in parallel (see \ref{decomp_meshes_parallel}).
This is because the mesh must be fine enough, and the Reynolds number high enough, in order to
generate turbulence over the step and resolve its passage downstream. More information on running
Fluidity in parallel is found in \ref{sect:running_fluidity_in_parallel}.

In practice the example is run in a very similar way to the other examples.
To run in serial, the example is run in exactly the same way to the other examples, using
the commands \option{make preprocess}, \option{make run} and \option{make postprocess}.
To run in parallel with your chosen number of processors (\option{np}), using the command
\option{make preprocess NPROCS=np} creates a mesh and decomposes it into (\option{np}) parts, and
the command \option{make run NPROCS=np} runs \fluidity\ as (\option{np}) processes on (\option{np}) processors.
The command \option{make postprocess NPROCS=np} runs the parallel-specific data processing script.

\begin{figure}
\centering
\fig[width=12.0cm]{examples_images/backward_facing_step/backward_facing_step_3d-schematic}
\caption{Schematic of the domain for the three-dimensional flow past a backward facing step
problem.}
\label{Fig:Schematic3d}
\end{figure}

Following \cite{le1997} the length scales are given by: $L_x=30$, $L_i=10$, $L_y=4$, $h=1$, $L_z=6$,
so that $L_z-h=5$ and the expansion ratio is $L_z/(L_z-h)=1.2$.
The base of the domain is located at $z=0$, the inflow plane is given by $x=-10$ with the step
at $x=0$, and the back of the domain in the spanwise direction is given by $y=0$.

\subsubsection{Geometry: 2D}
A schematic of the domain, showing adaptive mesh refinement, is shown in figure \ref{Fig:Schematic2d}.
In the 2D case the expansion ratio is 2, and the upper boundary is treated as no-slip,
consistent with \cite{armaly1983}.

\begin{figure}
\centering
\fig[width=17.0cm]{examples_images/backward_facing_step/backward_facing_step_2d-mesh}
\caption{Schematic of the domain for the two-dimensional flow past a backward facing step
problem, showing adaptive mesh refinement.}
\label{Fig:Schematic2d}
\end{figure}


\subsubsection{Initial and boundary conditions: 3D}
In the 3D case, the inflow boundary condition at $x=-10$ is a log profile given by
\begin{equation*}
u(z) =
  \begin{cases}
    0.0 & \text{if } z-h \leq z_0 \\
    \frac{u_{\tau}}{\kappa} \log \left(\frac{z - h}{z_0}\right) & \text{if } z_0 < z-h
  \end{cases}
\end{equation*}

with parameters $u_{\tau} = 0.1$, $z_0 = 0.01$ and $\kappa = 0.41$.

%A plot of this inflow profile is given in figure \ref{Fig:Inflow}.
%\begin{figure}
%\centering
%\fig[width=8.0cm]{images/StepInflow.pdf}
%\caption{Inflow profile.}
%\label{Fig:Inflow}
%\end{figure}

No-normal flow, free-stress boundary conditions are applied at the upper and lateral
(spanwise) boundaries:
\begin{eqnarray*}
&&w=0,\quad \frac{\partial u}{\partial z} = \frac{\partial v}{\partial z} = 0 \quad\textrm{--- upper boundary},\\
&&v=0,\quad \frac{\partial u}{\partial z} = \frac{\partial w}{\partial z} = 0 \quad\textrm{--- lateral boundaries}.
\end{eqnarray*}

Free-stress boundary conditions are applied at the outflow boundary boundary:
\begin{equation*}
\frac{\partial u}{\partial x} = \frac{\partial v}{\partial x} = \frac{\partial w}{\partial x} = 0.
\end{equation*}

No-slip boundary conditions are applied at the bottom of the domain and at the step down:
\begin{equation*}
u=v=w=0.
\end{equation*}

\subsubsection{Initial and boundary conditions: 2D}
In the 2D case, the inlet velocity profile is a log profile extending from each wall to the midpoint, with the same parameters as the 3D example:
\begin{equation*}
u(z) =
  \begin{cases}
    0.0 & \text{if } (z-h) \leq z_0 \\
    \frac{u_{\tau}}{\kappa} \log \left(\frac{z - h}{z_0}\right) & \text{if } z_0 < (z-h) \leq 0.5 \\
    \frac{u_{\tau}}{\kappa} \log \left(\frac{2h - z}{z_0}\right) & \text{if } 0.5 < (z-h) \leq (2h-z_0) \\
    0.0 & \text{if } 2h-z_0 < (z-h)
  \end{cases}
\end{equation*}


\subsection{Results: 2D}
Three snapshots of the velocity magnitude from the benchmark run at $Re=150$
are shown in figure \ref{Fig:velo-magnitude-2d} at times 5, 10 and 50 seconds.
Vertical profiles of $\vec{u}$ at several points downstream of the step are shown
in figure \ref{Fig:UProfiles2d}. The reattachment point is clearly between $x/h=2$ and $x/h=4$.

One of the metrics most often considered for this test case is the point at which the
flow which separates from the step reattaches to the bottom of the domain.
The length downstream of the step at which this happens
has been found from laboratory experiments and direct numerical simulations and is considered a
sensitive measure of the quality of the numerical method. It is typically used to examine the impact
of turbulence parameterisations but here will be used to examine the use of mesh adaptivity
as well as the numerical method.

The reattachment length was defined here to be the length (normalised by step height $h$)
from the step at which the zero-contour of the $x$-component of $\vec{u}$ intersects with
the bottom boundary. This quantity was computed from $\vec{u}$
using the VTK library. For the simulation described, the reattachment
length was approximately 3.6 times the step height, which is consistent with \cite{armaly1983}.
The precise value for the reattachment length is dependent on exact configuration on the domain and inflow
conditions, and also strongly on the Reynolds number of the flow.

\begin{figure}
\centering
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-2d-5sec}}
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-2d-10sec}}
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-2d-50sec}}
\caption{Snapshots of the velocity magnitude from the 2D run at times 5, 10 and 50 time units
(top to bottom) into the simulation from the smaller benchmark run.
The evolution of the dynamics to steady state can be seen, in particular the downstream movement
of the streamline reattachment point (indicated by contours of $U=0$).}
\label{Fig:velo-magnitude-2d}
\end{figure}

\begin{figure}
\centering
\fig[width=17.0cm]{examples_images/backward_facing_step/velo_profiles_2d}
\caption{Streamwise velocity profiles from the 2D run at $x/h=0, 2, 4 \text{ and } 6$
downstream of the step, where $h=1$ is the step height. The converged solution is in red.
The recirculation region is indicated by negative velocity in figure (b).
It is clear that the reattachment point is between $x/h=2$ and $x/h=4$.}
\label{Fig:UProfiles2d}
\end{figure}


\subsection{Results: 3D}
Three snapshots of the velocity vectors are shown in figure \ref{Fig:velo-magnitude-3d}
at times 5, 10 and 50 seconds.
Vertical profiles of $\vec{u}$ at several points downstream of the step are shown in figure
\ref{Fig:UProfiles3d}, in which the velocity data has been averaged across the span of the domain
to obtain quasi-2D data. The reattachment point is clearly between $x/h=6$ and $x/h=10$.
In fact the flow reattaches at $x/h \approx 8.3$.


\begin{figure}
\centering
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-3d-5sec}}
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-3d-10sec}}
\subfigure{\fig[width=15.0cm]{examples_images/backward_facing_step/velo-magnitude-3d-50sec}}
\caption{From top to bottom: vertical plane cuts through the 3D domain showing
the velocity magnitude at times 5, 25 and 50 time units.
The evolution of the dynamics to steady state can be seen, in particular the downstream movement
of the streamline reattachment point (indicated by contours of $U=0$).}
\label{Fig:velo-magnitude-3d}
\end{figure}

\begin{figure}
\centering
\fig[width=17.0cm]{examples_images/backward_facing_step/velo_profiles_3d}
\caption{Streamwise velocity profiles from the 3d run at $x/h=4, 6, 10 \text{ and } 19$
downstream of the step, where $h=1$ is the step height. The converged solution is in red.
The recirculation region is indicated by the negative velocity in figure (b).
It is clear that the flow reattaches between $x/h>6 \text{ and } 10$.}
\label{Fig:UProfiles3d}
\end{figure}


%As this is a highly turbulent problem, making quantitative comparisons of
%individual snapshots is impossible. However, time-averaged quantities are of diagnostic interest.
%Figure \ref{Fig:TimeAverage} shows 3 snapshots of the $u$ component of velocity from the large
%benchmark run and a time
%averaged field. The removal of fluctuating components in the velocity field can be seen.

%\begin{figure}
%\centering
%\subfigure{\fig[width=15.0cm]{images/Velocity1.pdf}}
%\subfigure{\fig[width=15.0cm]{images/Velocity33.pdf}}
%\subfigure{\fig[width=15.0cm]{images/Velocity64.pdf}}
%\subfigure{\fig[width=15.0cm]{images/VelocityAverage.pdf}}
%\caption{Snapshots of the $u$ velocity components at three time slices (top three frames) and the
%average field from 64 input snapshots spaced equally between times 70 and 102 (bottom).
%Contours are displayed at the $-0.05$, $0.0$, $0.05$, $0.1$, $0.5$ and $1.0$ levels.}
%\label{Fig:TimeAverage}
%\end{figure}



A more rigorous analysis would involve
repeating the experiment for a range of Reynolds numbers and comparing the reattachment
length of multiple model runs.
%It may be seen that pseudo-supermeshing is an efficient
%method to produce a common mesh suitable for the interpolation of fields from multiple
%meshes, such as is necessary in time-averaging.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%----------------------Sphere------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Flow past a sphere: drag calculation}
\label{sect:flow_past_sphere}
\subsection{Overview}
In this validation test uniform flow past an isolated sphere is simulated
and the drag on the sphere is calculated and compared to a curve optimised
to fit a large amount of experimental data.

\subsection{Configuration}
The sphere is of unit diameter centred at the origin. The entire domain is
the cuboid defined by $-10\le x\le 20$, $-10\le y\le 10$, $-10\le z\le 10$.
GiD is used to mesh the initial geometry.

The unsteady momentum equations with nonlinear advection and viscous terms
along with the incompressibility constraint are solved. Free slip velocity
boundary conditions are applied at the four lateral boundaries, $u=1$, $v=w=0$ is
applied at the inflow boundary $x=-10$, and a free stress boundary condition
applied to the outflow at $x=20$. 

A series of Reynolds numbers in the range
$Re\in [1,1000]$ are considered. The problem is run for a long enough
period that the low Reynolds number simulations reach steady state, and the
higher Reynolds number runs long enough that a wake develops behind the
sphere and boundary layers on the sphere are formed.  This is deemed
sufficient for the purposes of this test which is not an in-depth
investigation of the physics of this problem, nor an investigation of the optimal
set of numerical options to use. 

Here an unstructured
tetrahedral mesh is used along with mesh adaptivity. 
Figure \ref{fig:flow_past_sphere_2} shows a snapshot of the
mesh and velocity vectors taken from a Reynolds number 1000 simulation. The
mesh can be seen to be resolving the wake and the boundary layers on the
sphere with enhanced anisotropic resolution. At higher Reynolds numbers the
dynamics become more complex and if a full numerical study was being
conducted here more care would be taken is the choice of mesh optimisation
parameters and the use of averaged values from simulations allowed to run
for longer periods. The drag coefficient is calculated from
\begin{equation}
C_D = \frac{F_x}{\frac{1}{2}\rho u_0^2 A},\qquad F_x = \int_S (n_xp - n_i\tau_{ix})\;dS,
\label{eqn:drag_coeff}
\end{equation}
where $\rho$ is the density, taken here to be unity; 
$u_0$ is the inflow velocity, here unity; 
and $A$ is the cross-sectional area of the sphere, here $\pi^2/4$. 
$F_x$ is the force 
exerted on the sphere in the free stream direction;
$S$ signifies the surface of the sphere; $n$ is the 
unit outward pointing normal to the sphere 
($n_x$ is the $x$-component and $n_i$ the $i^{\textrm{th}}$ 
component, here summation over repeated indices is assumed); 
$p$ is the pressure and $\tau$ is the stress tensor;
see \citet{panton2006}.

\begin{figure}
\centering
\subfigure{
\includegraphics[width=6cm,clip]{examples_images/flow_past_sphere/sphere-Re1-streamlines.png}}
\subfigure{
\includegraphics[width=6cm,clip]{examples_images/flow_past_sphere/sphere-Re10-streamlines.png}}
\subfigure{
\includegraphics[width=6cm,clip]{examples_images/flow_past_sphere/sphere-Re100-streamlines.png}}
\subfigure{
\includegraphics[width=6cm,clip]{examples_images/flow_past_sphere/sphere-Re1000-streamlines.png}}
\caption{Streamlines and surface mesh in the flow past the sphere example. Top-left to bottom-right
show results from Reynolds numbers $Re=1,10,100,1000$.}
\label{fig:flow_past_sphere_1}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=15cm,clip]{examples_images/flow_past_sphere/sphere-Re1000-combined.pdf}
\caption{Details of the mesh and flow at $Re=1000$.}
\label{fig:flow_past_sphere_2}
\end{figure}

\subsection{Results}
Figure \ref{fig:flow_past_sphere_1} shows streamlines close to the sphere and the surface mesh.
The mesh can be seen to be much finer on the sphere compares to the far wall seen in the background.
This is empahsised in figure \ref{fig:flow_past_sphere_2} where a more detailed plot of the mesh (with
half of the domain removed) over the whole domain and close to the sphere, and the velocity vectors
close to the sphere are shown.

Figure \ref{fig:drag} shows a comparison between the computed drag coefficient with
a correlation (to a large amount of laboratory data) taken from \citet{brown2003}:
\begin{equation}
C_D = \frac{24}{Re}\left(1+0.15Re^{0.681}\right) + \frac{0.407}{1+\frac{8710}{Re}}.
\label{eqn:sphere_drag_corr}
\end{equation}
Good agreement can be seen at the range of Reynolds numbers tested in this exercise.


\begin{figure}
\centering
\includegraphics[width=8cm,clip]{examples_images/flow_past_sphere/Sphere_Drag.pdf}
\caption{Comparison between the numerically calculated drag coefficients ($C_D$, circles) and the correlation \eqref{eqn:sphere_drag_corr} (solid line)
for $Re=1,10,100,1000$.}
\label{fig:flow_past_sphere_3}
\end{figure}



\subsection{Exercises}
\begin{enumerate}
\item We actually compute the (vector) force on the sphere and output this to the stat file. This can then be converted to the drag coefficient 
via \eqref{eqn:drag_coeff}. Write a Python function to do this conversion and the error from the correlation \eqref{eqn:sphere_drag_corr}.
\item Try varying some of the discretisation and adaptivity parameters to see what the impact on the accuracy of the
calculated drag is.
\item Try changing the shape of the object, e.g. benchmark data is also available for flow past a cylinder.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%----------------------CHANNEL------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Rotating periodic channel}
\label{sect:periodic_channel}

\subsection{Overview}

This problem provides a convergence test for the \PoDGPt\ element pair.
Utilising almost all the terms of the incompressible Navier-Stokes equations
in two dimensions.

The domain is a unit square which is periodic in the zonal direction. The
North and South boundaries are zero slip (i.e. $\vec{u}=0$). The remaining
parameters are as follows:

\begin{tabular}{lll}
  Coriolis parameter & $f$ & $1$ \\
  Viscosity & $\nu$ & $1$ 
\end{tabular}

The flow is driven by a velocity source term:
\begin{equation}
  \vec{F}=
  \begin{bmatrix}
    y^3 \\
    0
  \end{bmatrix}
\end{equation}

So the whole system of equations becomes:
\begin{gather}
  \ppt{u}+u\ppt[x]{u}-v=-\grad p + \grad^2 u +y^3\\
  \ppt{v}+v\ppt[y]{v}+u=-\grad p + \grad^2 v\\
  \div\vec{u}=0
\end{gather}

This system has a steady solution at:
\begin{gather}
  \vec{u}=
  \begin{bmatrix}
    \frac{1}{20}(y-y^5)\\
    0
  \end{bmatrix}\\
  p=\frac{1}{120}y^6-\frac{1}{40}y^2+C
\end{gather}
Where $C$ is an arbitrary constant resulting from the use of Dirichlet
boundary conditions on both the domain boundaries.

\subsection{Results}

Since the maximum velocity in the domain is approximately 0.025, the
Reynolds number for this solution is much smaller than 1 so the flow is
safely within the laminar regime and will remain steady. Figure
\ref{fig:periodic_channel}\ shows the forcing term for velocity and the
analytic solutions for velocity and pressure.


\begin{figure}[htbp]
  \centering
  \onlypdf{\begin{pdfdisplay}}
    \psfrag{u source}{$\vec{u}$ source}
    \psfrag{u solution}{$\vec{u}$ solution}
    \psfrag{p solution}{$p$ solution}
    \psfrag{0}{0}
    \psfrag{0.2}{0.2}
    \psfrag{0.4}{0.4}
    \psfrag{0.5}{0.5}
    \psfrag{0.2}{0.6}
    \psfrag{0.8}{0.8}
    \psfrag{1}{1}
    \psfrag{y}{$y$}
    \psfrag{-0.01}{-0.01}
    \psfrag{-0.02}{-0.02}
    \psfrag{0.01}{0.01}
    \psfrag{0.02}{0.02}
    \psfrag{0.03}{0.03}
    \includegraphics[width=1.1\textwidth]{examples_images/rotating_channel/analytic_solution.eps}
  \onlypdf{\end{pdfdisplay}}
  \caption{Velocity forcing term and analytic solutions for velocity and
    pressure for the rotating periodic channel test case. Note that each of
    these quantities is constant in the $x$ direction.}
  \label{fig:periodic_channel}
\end{figure}

The convergence test is conducted by repeating this simulation on unstructured meshes
with typical resolution $1/4$, $1/8$, $1/16$, $1/32$, $1/64$. The results
are then compared to the analytic solution. In the case of pressure, the
answer is translated to account for the arbitrary constant. Figure
\ref{fig:periodic_channel_error}\ shows the $\textrm{L}^2$ error for
velocity and pressure. It is apparent that both quantities converge at
second order.

\begin{figure}[htbp]
  \centering
  \onlypdf{\begin{pdfdisplay}}
    \psfrag{u error}{$\vec{u}$ error}
    \psfrag{p error}{$p$ error}
    \psfrag{O\(dx^2\)}{$O(\d x^2)$}
    \psfrag{dx}{$\d x$}
    \psfrag{1.0e+00}{\small\hspace{1em}$1$}
    \psfrag{1.0e-01}{\small\hspace{1em}$10^{-1}$}
    \psfrag{1.0e-02}{\small\hspace{1em}$10^{-2}$}
    \psfrag{1.0e-03}{\small\hspace{1em}$10^{-3}$}
    \psfrag{1.0e-04}{\small\hspace{1em}$10^{-4}$}
    \psfrag{1.0e-05}{\small\hspace{1em}$10^{-5}$}
    \psfrag{1.0e-06}{\small\hspace{1em}$10^{-6}$}
    \includegraphics[width=1.1\textwidth]{examples_images/rotating_channel/convergence.eps}
  \onlypdf{\end{pdfdisplay}}  
  \caption{Error in the pressure and velocity solutions for the rotating channel as a function of resolution.}
  \label{fig:periodic_channel_error}
\end{figure}

\subsubsection{Exercises}

This example can be used to understand the use of analytic forcing
functions in \fluidity. Try modifying the function
\lstinline[language=python]{channel_viscous.forcing}. The forcing function
and the analytic velocity and pressure results can be visualised by running
the \lstinline[language=python]{plot_theory}\ script. 

Examine the rest of the \lstinline[language=python]{channel_viscous}\ Python
module to see how the analytic solution is automatically calculated from the
forcing function. Next, examine the \option{AnalyticUVelocitySolutionError}\
and \option{AnalyticPressureSolutionError} to see how this is used to
calculate the error in the model solution. The documentation of the Python
state interface in appendix \ref{chap:python}\ may be useful.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------ANNULUS-------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Baroclinic Annulus}
\label{sect:annulus}

\subsection{Overview}

The rotating annulus is a classic laboratory scale analogue for large scale
geophysical flows and processes. It dates back to the PhD work of Raymond Hide,
originally developed as an analogue for Earth core dynamics \citep{hide1952} and only
later recognised for its relevant to atmospheric flows \citep{hide1953, hide2006}.
In contrast to earlier dish-pan type experiments \citep{fultz1951}, the rotating
annulus allows for rigorous reproducible experiments and was instrumental in the
development of the theory of deterministic chaos \citep{lorenz1963}.

The rotating annulus test problem is configured to simulate the classic
differentially heated baroclinic annulus. The dynamics
of this system are dependent upon a number of external parameters, most notably
the thermal Rossby (or Hide) number:

\begin{equation}\label{eqn:hide_number}
  \Theta = \frac{g \alpha \Delta T}{\Omega^2} \frac{d}{(b - a)^2},
\end{equation}

representing the relative strength of thermal forcing to rotation, and the Taylor number:

\begin{equation}\label{eqn:taylor_number}
  T = \frac{\Omega^2}{\nu^2} \frac{4(b - a)^5}{d},
\end{equation}

representing the relative strength of rotation to viscous dissipation (a rotational
Reynolds number \citep{lorenz1967}). Here $\Delta T$ is the thermal forcing, $d$ is the tank depth and $a$ and $b$
are the smaller and larger annulus radii respectively.

The system exhibits a range of dynamical regimes depending upon the external parameters.
In order of increasing rotation
rate these are, broadly speaking: geometrically modified natural convection,
axisymmetric Hadley regime, non-axisymmetric Rossby regime with fully developed
baroclinic waves, and geostrophic turbulence. See \citet{hide1975} and \citet{frueh1997}
for a more complete description.

The emergent regime is dependent upon a number of features of the flow. At
sufficiently high rotation rate (low Rossby number) the flow is, to leading
order, in thermal wind balance, with the dynamics being a small perturbation to
this background state. Furthermore, the dynamics of baroclinic instability are
highly dependent upon the representation of the active Ekman layers at the tank
base and lid \citep{hide1969}. It is therefore essential that a numerical model
of the rotating annulus be able to represent these processes with a high degree
of accuracy.

\subsection{Configuration}

The model parameters in the rotating annulus test problem have been chosen such
that one expects a baroclinically unstable flow with a steady dominant mode three
wave. Owing to hysteresis in the system these parameters are also consistent with
a dominant mode two wave.

The model is configured to use the \Poo velocity-pressure element pair with a \Ptwo
geostrophic pressure. Temperature is discretised via a control volume method using
the Sweby limiter. Dynamic mesh adaptivity is applied with all of velocity, pressure
and temperature interpolated via Galerkin projection. The simulation is initialised
with a linear stratification, and uses an initial mesh stretched in
the radial and azimuthal direction as described in \citet{farnell1975}. The
configuration uses an adaptive timestep targetting a CFL number of 1.0, and is
integrated for 600\s[] on 8 processes.

The test has a runtime of approximately 20 hours on cx1.

\subsection{Results}

At simulation end it is tested that a dominant mode three wave has developed,
although it is not expected that this wave will have equilibrated after this
length of simulated time. The heat transport of this system is compared against
the experimental value from \citet{read2003}. Other properties of the system,
including the integrated temperature, the temperature \Ltwo norm, the dominant
mode amplitude and the dominant mode drift rate are also measured and compared
against previous simulations for regression testing purposes.

\begin{figure}[ht]
  \centering
  \fig[width=0.48\textwidth]{./examples_images/annulus/TemperatureSlices}
  \caption{Vertical and horizontal cuts through the final temperature field
           for the baroclinic annulus test case. Normalised temperature
           $\bar{T} = T / \Delta T$.}
\end{figure}

\begin{figure}[ht]
  \centering
  \subfigure{\fig[width=0.46\textwidth]{./examples_images/annulus/ArrayHovmueller}}
  \subfigure{\fig[width=0.46\textwidth]{./examples_images/annulus/ArrayFft}}
  \caption{Left: Hovm\"uller plot of the mid-radius mid-height temperature field
           for the baroclinic annulus test case. Right: FFT of left, showing
           growth of the baroclinic modes and a final dominant mode three wave.}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---Open ocean deep convection--------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Open ocean deep convection}
\label{sect:OODC}
\subsection{Overview}
Open-ocean deep convection (OODC) has been recognised as an
important mixing process for over 25 years, and
has been studied in the ocean, simulated in the laboratory, and modelled numerically.
A much-cited study in the field of numerically simulating
open-ocean deep convection is that of \cite{jones1993} and this is recreated here.
In their work, a fixed resolution ($240 \times 240 \times
100$m in $X, Y, Z$) model is used to study the physics and
characteristic scalings of OODC. Their simulations use a disc
of cooling in a simple box geometry to investigate the effects of rotation.

Ocean convection is important to the meridional overturning
circulation. It is a small scale non-hydrostatic process which
is difficult to capture in general circulation models. Applying
an unstructured adaptive mesh model to study this process is
novel, and this approach may produce new insights into the
simulation and parameterisation of convection in structures and
unstructured mesh models.

Although OODC itself is a small-scale process, it interacts with
processes on the basin-scale, both in the preconditioning stage and
in the sinking and spreading stages. It is therefore important for us
to be able to represent a large range of scales. Finite elements and adapting
unstructured meshes are particularly suited for this application, as the
resolution used can vary in size smoothly over a wide area.

\subsection{Configuration}

\subsubsection{Geometry}

%\begin{figure}
%\centering
%\fig[width=8.0cm]{images/oodc-schematic.pdf}
%\caption{Schematic of the domain for the three-dimensional open ocean deep convection
%problem.}
%\label{Fig:Schematic}
%\end{figure}


A schematic of the domain is shown in figure \ref{Fig:Schematic}.
The domain is 32km square in the horizontal and 2km deep. A cooling disk of radius
8km is centred at middle of the upper boundary.




\subsubsection{Parameters}
The thermal expansion coefficient is set to
$\alpha=2 \times 10^{-4} \,\mathrm{K}^{-1}$ and gravity to $g=9.81 \,\mathrm{m}\,\mathrm{s}^{-2}$.

The eddy viscosity
and thermal diffusivity were set to the same values as those
used in \cite{jones1993}: $\kappa_h = 5.0 \mathrm{m}^2\mathrm{s}^{-1}$ and
$\kappa_v = 0.2 \mathrm{m}^2\mathrm{s}^{-1}$.


\subsubsection{Initial and boundary conditions}
The domain is initialised at rest with a weak temperature stratification
in the vertical, with a top-to-bottom temperature difference of
$0.05\,$K.
This therefore corresponds to a buoyancy frequency ($N$) value
of $2.2 \times 10^{-4} \,\mathrm{s}^{-1}$.


A heat loss of $-800\,\mathrm{W}\,\mathrm{m}^{-2}$ is
applied as a flux boundary condition. Assuming density $\rho=1000\,\mathrm{Kg}\,\mathrm{m}^{-3}$,
specific heat capacity $c_p=4\times 10^3\,\mathrm{J}\,\mathrm{Kg}^{-1}\,\mathrm{K}^{-1}$,
the flux $q=\bmn\cdot\left ( \kaptens_T  \nabla T\right)$
takes the value $q = 2\times 10^{-4}\,\mathrm{K}\,\mathrm{m}^{-1}\,\mathrm{s}^{-1}$.
This value is applied in a disk of radius $7750\,\mathrm{m}$ with a linear ramp to zero flux to a radius
$8000\,\mathrm{m}$. In addition, this forcing is only applied for the first 48 hours of the simulation and
then switched off, so that the restratification stage of the problem can be considered.



No-normal flow, free-stress boundary conditions are applied at the upper and lateral
(spanwise) boundaries.


\subsection{Results}




\section{Water column collapse}

\subsection{Overview}
A commonly used validation experiment for multi-material models is that of a collapsing column of liquid, normally water, within an atmosphere or vacuum \citep{lakehal_interface_2002}, also known as the dam break problem.  In the experimental set-up a reservoir of water is held behind an impermeable barrier separating it from the rest of the tank.  The barrier is then quickly removed, allowing the water column to collapse and flood the remaining sections of the tank.  In the numerical analogue the initial condition is generally taken as the trapped water column, still behind the dam.  At the start of the simulation the barrier is imagined to have been removed instantaneously and switching on gravity, $|g| = 9.81$, causes the column to collapse.   Several experimental set-ups have been published and used as comparison and validation tools for numerical models \citep{martin_part_1952, greaves_simulation_2006}.  Those with water depth gauges distributed throughout the tank are particularly useful, allowing the direct comparison of data.  Furthermore, pressure gauges located on the tank walls or on any obstacles within the tank provide another useful validation tool.

In this example, \fluidity\ is used to simulate a simple dam break experiment \citep{zhou_nonlinear_1999}.  The example demonstrates the following functionality:

\begin{itemize}
\item 2D flow
\item Multi-material flow
\item Incompressible flow
\item Inviscid flow
\item Mesh adaptivity
\item Static detectors
\end{itemize}

The simulation illustrated here took $\sim$2 hours to run in serial on a Intel Xeon X5355 2.66 GHz processor.

\subsection{Problem specification}
The experiment on which this example is based was a simple dam break problem in a $3.22\times2\times1m$ (length $\times$ height $\times$ depth) tank \citep{zhou_nonlinear_1999}.  A reservoir of water $1.2\times0.6\times1m$ (length $\times$ height $\times$ depth) was held behind a barrier at one end of the tank.  Water depth gauges were placed at two points, marked H1 and H2 in Figure \ref{fig:zhouinitial}(a), at $x_1 = 2.725m$ and $2.228m$ respectively.  Additionally, a pressure gauge was located at the point marked P2 in Figure \ref{fig:zhouinitial}(a), at $x_2=0.16m$ on the wall facing the initial water column.

As no variations were introduced in the third dimension, the experiment is reproduced here numerically in two dimensions within the domain $\Omega$: $x_1 \in [0,3.22]$, $x_2 \in [0,2]$ \citep{lee_numerical_2002, colagrossi_numerical_2003, park_volume-of-fluid_2009}.  The two materials (water and air) are distinguished by scalar fields $\alpha_k$ representing their volume fraction, where the volume fraction of air $\alpha_2 = 1-\alpha_1$ and $\alpha_1$ is the volume fraction of water. The initial condition of the water volume fraction is shown in Figure \ref{fig:zhouinitial}(a).  The presence of water is indicated as a grey region and the interface to air is delineated by contours at volume fraction values of $0.025$, $0.5$ and $0.975$.  The densities of the water and air are taken as $ 1,000kg\,m^{-2}$ and $1kg\,m^{-2}$ respectively.  Both fluids are treated inviscidly. As the simulation is inviscid, free slip boundary conditions are imposed on the tank bottom, $x_2=0$, and sides, $x_1=0,\,3.22$.  The top of the tank, $x_2=2$, is left open.

\begin{figure}[tbp]
\hspace{1cm}(a)
\begin{center}
\input{examples_images/water_collapse/initial_setup.tex}
\end{center}
\hspace{1cm}(b)
\begin{center}
\includegraphics[width=10.2cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_0_mesh.pdf}
\end{center}
\caption{(a) Initial set-up of the water volume fraction, $\alpha_1$, and the velocity and pressure boundary conditions for the two-dimensional water column collapse validation problem \citep{zhou_nonlinear_1999}. The presence of water is indicated as a grey region and the interface to air is delineated by contours of the volume fraction at $0.025$, $0.5$ and $0.975$.  The locations of the pressure (P2) and water depth gauges (H1, H2) are also indicated. (b) The adapted mesh used to represent the initial conditions.}
\label{fig:zhouinitial}
\end{figure}

The water volume fraction, $\alpha_1$, is solved for using an advection equation (REFMARKER).  It is advected using HyperC on a control volume mesh (REFMARKER), while the velocity and pressure are discretised using the P0P1$_{\text{CV}}$ element pair (REFMARKER) with $\theta=1/2$ and $\theta_i=1/2$ (REFMARKER).  

This example employs an adaptive mesh (REFMARKER). The minimum edge length in the mesh is constrained to $2mm$. The upper bound on the edge lengths was specified as half the domain length and height in each dimension.  The pressure and water volume fraction were directly adapted to using interpolation error bounds, $\hat{\epsilon}$, of $1,000$ and $0.05$ respectively.  As the velocity is element centred it was first projected to the vertices before being adapted to with an interpolation error bound of $1$ for each component.  Given the ranges of these fields seen in the fixed mesh runs these correspond to desired errors of less than 5\% for each field. The volume fraction is transferred between successive meshes using a minimally diffusive bounded projection algorithm.  The velocity is transferred using a straightforward projection while the pressure is consistently interpolated using the linear basis functions from its parent mesh. For details of the remaining adaptivity settings we refer to the documented flml file.  The initial mesh using these settings is shown in Figure \ref{fig:zhouinitial}(b). 

The timestep is selected to achieve a Courant number (REFMARKER) of $2.5$ while the advection equation uses approximately $10$ subcycles (REFMARKER) so the volume fraction is advected at a Courant number of $0.25$.  

\subsection{Results}
Several timesteps of the example simulation can be seen in Figure \ref{fig:zhouwholea} where the interface is represented by contours of the water volume fraction, $\alpha_1$, at $0.025$, $0.5$ and $0.975$.  Similar images can be generated by visualising the vtu files using Paraview or Mayavi2 (REFMARKER).

\begin{figure}[tbp]
\begin{center}
% \newcolumntype{V}{>{\centering\arraybackslash} m{7cm} }
\begin{tabular}{ll}
(a) $t = 0.5$ & (b) $t = 1.0$   \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_100.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_200.png} \\
(c) $t = 1.5$ & (d) $t = 1.625$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_300.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_325.png} \\
(e) $t = 1.75$ & (f) $t = 1.875$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_350.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_375.png} \\
(g) $t = 2.0$ & (h) $t = 2.5$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_400.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_500.png} \\
\end{tabular}
\caption{The evolution of the water volume fraction, $\alpha_1$, over several timesteps.  The presence of water, $\alpha_1=1$, is indicated as a grey region and the interface to air, $\alpha_1=0$, is delineated by contours at $\alpha_1 = 0.025$, $0.5$ and $0.975$.}
\label{fig:zhouwholea}
\end{center}
\end{figure}

\begin{figure}[tbp]
\begin{center}
% \newcolumntype{V}{>{\centering\arraybackslash} m{7cm} }
\begin{tabular}{ll}
(a) $t = 0.5$ & (b) $t = 1.0$\\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_100_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_200_mesh.pdf} \\
(c) $t = 1.5$ & (d) $t = 1.625$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_300_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_325_mesh.pdf} \\
(e) $t = 1.75$ & (f) $t = 1.875$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_350_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_375_mesh.pdf} \\
(g) $t = 2.0$ & (h) $t = 2.5$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_400_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_500_mesh.pdf} \\
\end{tabular}
\caption{The evolution of the adaptive mesh over the same timesteps displayed in Figure \ref{fig:zhouwholea}.  The mesh can be seen to closely follow the interface between the water and air.}
\label{fig:zhouwholemesh}
\end{center}
\end{figure}

The images show the column collapse (Figure \ref{fig:zhouwholea}(a)), run-up against the opposing wall (Figure \ref{fig:zhouwholea}(b)) and the subsequent overturning wave (Figure \ref{fig:zhouwholea}(c, d)) and entrainment of air bubbles (Figure \ref{fig:zhouwholea}(e--h)).  

\begin{figure}[tbp]
\begin{center}
%\newcolumntype{V}{ m{7cm} }
\begin{tabular}{cc}
\hspace{1cm}(i) H1 & (ii) H2  \\
\includegraphics[width=7cm]{examples_images/water_collapse/water_gauge_H1.pdf} & \includegraphics[width=7cm]{examples_images/water_collapse/water_gauge_H2.pdf}\\
\end{tabular}
\caption{Comparison between the experimental (circles) and numerical water gauge data at H1 (i) and H2 (ii), $x_1 = 2.725m$ and $2.228m$ respectively.  The letters along the top of the graphs indicate the times corresponding to Figure \ref{fig:zhouwholea}(a--h).  Experimental data taken from \citet{zhou_nonlinear_1999} through \citet{park_volume-of-fluid_2009}.}
\label{fig:zhoudepth}
\end{center}
\end{figure}

For validation purposes, the post-processing script provided for this example extracts information from the detector file (pressure) and from the water volume fraction field stored in the vtu files (water depth) and plots these data in comparison with the experimental results. The water depth gauge data is displayed in Figure \ref{fig:zhoudepth} alongside the experimental data.  The numerical results show the total thickness of water at the points H1 and H2, discounting any air bubbles that cross the gauges.  The simulation results show a close similarity to the experimental results with the exception of a small lip of water when the initial water head passes the gauge.  It is unclear what causes this structure, though it may be related to the initial withdrawal of the barrier in the experiment or drag effects from the bottom of the tank.  All previous published attempts to model the experiment also fail to reproduce this initial lip \citep{zhou_nonlinear_1999, lee_numerical_2002, colagrossi_numerical_2003, park_volume-of-fluid_2009}.

After $t=1.5s$ the overturning wave starts to pass the water gauges and the match between the experimental results and the numerical simulation deteriorates. As would be expected from such complex behaviour, all previous published attempts have also failed to reproduce the experimental depth gauge data after this point.  However, the broad pattern and average depth observed in the simulation after $t=1.5s$ can be seen in Figure \ref{fig:zhoudepth} to match the experiment reasonably well.

\begin{figure}[tb]
\begin{center}
\includegraphics[width=10cm]{examples_images/water_collapse/pressure_gauge_P2.pdf}
\caption{Comparison between the experimental (circles) and numerical pressure gauge data at P2, $x_1 = 3.22m$, $x_2 = 0.16m$.  The letters along the top of the graphs indicate the times corresponding to Figure \ref{fig:zhouwholea}(a--h).  Experimental data taken from \citet{zhou_nonlinear_1999} through \citet{park_volume-of-fluid_2009}.}
\label{fig:zhoupressure}
\end{center}
\end{figure}

Experimental pressure gauge data are also available at the point P2, $(3.22,0.16)m$, on the right wall of the tank.  This is compared to the numerical pressure results in Figure \ref{fig:zhoupressure}.  After the initial noise in the experimental data, a sudden step in pressure is seen as the water run-up reaches the pressure gauge at about $t=0.6s$.  This is also seen in the numerical simulations however it is slightly delayed, occurring at $t=0.7s$.  As upwinding is being used in the discretisation of the velocity field, the delay may be due to numerical viscosity slowing the advancing water front.  However, as the delay was not as extreme at the depth gauges H1 and H2 other factors may also play a role.  For instance, if the lip seen in the experimental water gauge data is a head on the water front, that has not been reproduced numerically, it may reach the height of the pressure gauge faster than a front with no head.

Once the pressure jump occurs the experimental and numerical data are in broad agreement until the overturning wave impacts with the water layer at approximately $t=1.5s$ (Figure \ref{fig:zhouwholea}(c)).  At the point of contact a pressure pulse is transmitted to the pressure gauge resulting in a modest pressure spike in the experimental data.  This is matched by slightly delayed pressure pulses in all the numerical simulation.  However, the pulses seen in the numerical data are of a much larger magnitude than the experimental data. This discrepancy may be due to the fact that in the experiment the pressure gauge measures the pressure over a broader area than in the simulation. 

\subsection{Exercises}
To explore the functionality of \fluidity, the following variations on this example would be constructive learning exercises:

\begin{itemize}
\item Disable the adaptivity option to run on a fixed mesh
\item Alter the water/air viscosity/density
\item Modify the tank geometry
\end{itemize}

\section{The restratification following open ocean deep convection}

\subsection{Overview}

This is the final stage of open ocean deep convection, when the dense water column formed during the convective phase mixes with the surrounding fluid.  Baroclinic eddies are thought to be an important mixing mechanism. The example here is taken from \cite{rousset09}. 

\subsection{Configuration}

The domain is a cylinder of diameter $L=500\unit{km}$ and height $H=1\unit{km}$. The aspect ratio is given by $R=L/H=500$. This is relatively high, and it affects some of the settings that must be used in fluidity.  The initial temperature field is shown in figure \ref{fig:rousset-init}. The temperature is linearly strafified except inside the cylinder in the middle with radius 70km, which is cooler than the surroundings. 

\begin{figure}[h]
\begin{center}
\includegraphics[width=10cm]{examples_images/restratification_after_oodc/rousset-init.png}
\caption{A vertical slice throught the domain showing the initial temperature stratification. The domain is a cylinder of radius 250 km and height 1 km. }
\label{fig:rousset-init}
\end{center}
\end{figure}

\subsection{Mesh}

The mesh used is a layered mesh, which is created within fluidity from the two dimensional input mesh circle.*. The finished mesh has nodes which are aligned in columns in the vertical. The elements are unstructured tetrahedra. The columnar ararangement of the nodes is important because the problem has a large aspect ratio, and the elements themselves are wider than they are tall. A fully unstructured mesh would create significant errors in the pressure, which then cause errors in the velocity. The layered mesh may be considered to be a special case of the two plus one mesh, in which the nodes are still vertically aligned, but there are different amounts of resolution in different areas of the domain. The quadrature degree is set to four.

\subsection{Discretisation}

The velocity is solved for using a discontinuous galerkin discretisation. A continuous galerkin discretisation is used for both pressure and temperature, with a polynomial order of 2 for pressure and 1 for temperature. 

\subsection{Other fluidity options}

There are some other options that are chosen specifically because this is large aspect ratio and rotating. These options may be checked by using the Large Scale Ocean options check (see section \ref{section:large-scale-ocean}).

\subsubsection{Time stepping}
\begin{itemize}
\item \option{\ldots/timestepping/nonlinear\_iterations} option is $2$ 
\item \option{\ldots/material\_phase/equation\_of\_state/subtract\_out\_hydrostatic\_level} is on.
\end{itemize}

\subsubsection{Velocity options}
\begin{itemize}
\item \option{\ldots/equation} is Boussinesq
\item \option{\ldots/spatial\_discretisation} is discotinuous galerkin
\item \option{\ldots/spatial\_discretisation/advection} is upwind
\item \option{\ldots/spatial\_discretisation/advestion/integrate\_advection\_by\_parts} is twice
\item \option{\ldots/spatial\_discretisation/discontinuous\_galerkin/lump\_mass\_matrix} is off
\item \option{\ldots/spatial\_discretisation/viscosity\_scheme} is compact discontinuous galerkin
\item \option{\ldots/spatial\_discretisation/advection/conservative\_advection} is set to $0.0$
\item \option{\ldots/temporal\_discretisation/theta} is $0.5$ (Crank-Nicolson)
\item \option{\ldots/temporal\_discretisation/conservative\_advection} is set to $0.0$
\item \option{\ldots/solvers}  gmres 
\item \option{\ldots/solvers/preconditioner} is sor
\end{itemize}
An Absorption field is added under Velocity to allow larger time steps to be taken, otherwise the time steps would be limited by the scale of the baroclinic waves.  This term has a vertical component equal to  ${\frac{1}{\rho_0}} {\theta} {\Delta} {t} {g} {\frac{\partial \rho}{\partial z}}$ and the other components are zero. $\rho_0$ is the reference density, $\theta$ is the value set under \\* \option{\ldots/Velocity/temporal\_discretisation/theta}, ${\Delta} {t} $ is the timestep, $g$ is the acceleration due to gravity and $\frac{\partial \rho}{\partial z}$ is the background density stratification.   In this case the absorption term is $0.025$ in the vertical and $0.0$ in the horizontal. The \\* \option{\ldots/Absorption/include\_pressure\_correction} option is turned on.


\subsubsection{Pressure options}

This is continuous galerkin discretisation, with a mesh of polynomial order two.
\begin{itemize}
\item \option{\ldots/spatial\_discretisation} is Continuous Galerkin
\item \option{\ldots/solver/vertical\_lumping}  on
\item \option{\ldots/spatial\_discretisation/remove\_stabilitation\_term} on
\item \option{\ldots/spatial\_discretisation/integrate\_continuity\_by\_parts}  on
\item \option{\ldots/scheme/poisson\_pressure\_solution} is only first time step
\item \option{\ldots/scheme/use\_projection\_method}  on
\item \option{\ldots/solver} is  cg 
\item \option{\ldots/solver/preconditioner} is  mg
\end{itemize}

\subsubsection{Free Surface Field}
This is a diagnostic field. There is also a free surface boundary condition under Velocity.

\subsection{Results}

Figure \ref{fig:rousset-40m} shows the temperature field for a cross section at 40 m depth. 


\begin{figure}[h]
\begin{center}
\subfigure [0 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0001.png}}
\subfigure [5 days]{\includegraphics [width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0002.png}}
\subfigure [10 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0003.png}}
\subfigure [15 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0004.png}}
\subfigure [20 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0005.png}}
\subfigure [25 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0006.png}}
\subfigure [30 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0007.png}}
\subfigure [35 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0008.png}}
\subfigure [40 days]{\includegraphics[width=5cm]{examples_images/restratification_after_oodc/5000/rousset-res5000-depth-40m0009.png}}
\caption{The temperature cross-section at a depth of 40m.}
\label{fig:rousset-40m}
\end{center}
\end{figure}


