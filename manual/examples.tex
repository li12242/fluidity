\chapter{Examples}
\label{chap:examples}
\section{Introduction}
\label{sect:examples_introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------One-dimensional advection-------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{One dimensional advection}
\label{sect:oned_advection}
\subsection{Overview}
In this test example a very simple one-dimensional problem is 
studied: the advection of an inital ``top hat'' distribution 
of a tracer (see figure ???). Since this test runs in a  
short time, it allows users to play around with various
settings, e.g. spatial discretisation options, adaptivity 
and interpolation settings, etc., and quickly see the results
of their changes.

\subsection{Configuration}
This example provides three basic configurations, corresponding to
the three main discretisation types of the advection-diffusion equation
available in fluidity:
\begin{itemize}
\item {\bf Continuous Galerkin}, section ???
This is the most basic finite-element discretisation that is simple 
and fairly efficient. It is however not very good at advection
of discontinuous tracers. In this example SUPG stabilisation 
is applied to improve the results.
\item {\bf Discontinuous Galerkin}
\dots
\item {\bf Control Volume}
\dots
\end{itemize}
Adaptivity and interpolation options.
Timestepping.

\subsection{Results}
\subsection{Exercises}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------THE LOCK-EXCHANGE---------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The lock-exchange}
\label{sect:lock_exchange}
\subsection{Overview}
\label{sect:lock_exchange_overview}

The lock-exchange is a classic laboratory-scale fluid dynamics problem, \citep{fannelop_94, huppert_06, simpson_87}. A flat-bottomed tank is separated into two portions by a vertical barrier. One portion, the `lock', is filled with the source fluid. This is of different density to the ambient fluid which fills the other portion. As the barrier is removed, the denser fluid collapses under the lighter. Two gravity currents form and propagate in opposite directions, one above the other, along the tank. After an initial acceleration, the gravity current fronts travel at a constant speed until the end walls exert an influence or viscous forces begin to dominate, \citep{cantero_07, hartel_99, huppert_80}. At the current front a bulbous head may develop and become taller than the trailing fluid. A shear instability can manifest at the density-interface (hereafter interface) between the two fluids, \citep{turner_73}, and this leads to the formation of Kelvin-Helmholtz billows that enhance mixing.

The lock-exchange has been the subject of many theoretical, experimental and numerical studies, and the front speed (or Froude number) is commonly calculated, making it an excellent diagnostic for verification of \fluidity\, e.g. \citep{benjamin_68, klemp_94, hartel_00}. Furthermore the same physical processes are that are encountered in gravity currents over a range of scales are incorporated. Therefore, the lock-exchange presents a tractable means of studying the processes involved and contributes to our understanding of real-world flows, such as sediment-laden density currents and oceanic overflows, and their impact.

In this example, \fluidity\ is used to simulate a lock-exchange and the following functionality is demonstrated:

\begin{itemize}
\item 2D flow
\item Non-hydrostatic flow
\item Incompressible flow
\item Boussinesq flow
\item Mesh adaptivity

\end{itemize}

\subsection{Configuration}
\label{sect:lock_exchange_configuration}

The domain and physical parameters are set up after \cite{fringer_06} and \cite{ozgokmen_07}, table \ref{tab:le_physical_parameters}. The domain is a 2D rectangular box, $0\leq x \leq 0.8\,$m, $0 \leq z \leq 0.1\,$m. Initially, dense, cold water of $T = -0.5\,^\circ$C fills one half of the domain, $x<0.4\,$m, and light, warm water of $T = 0.5\,^\circ$C fills the other half, $x\geq0.4\,$m, figure \ref{fig:lock_exchange}. At $t=0\,$s, ${\bf u} = {\bf 0}$ everywhere. A no-slip boundary condition is applied along the bottom of the domain, ${\bf u = 0}$ at $z=0$, and a free-slip boundary condition is applied to the top of the domain and the side walls, ${\bf u\cdot\bf n} = 0$ at $z = 0.1\,$m and $x = 0.0,\, 0.8\,$m.

The basic choices for the numerical set-up are outlined in table \ref{tab:le_numerical_configuration}. They comprise a set of standard options for a buoyancy-driven flow such as the lock-exchange. The mesh is adapted to both the velocity and the temperature fields.  

\begin{table}[th]
\centering
\begin{tabular}[h]{l   c  c }  \hline
gravitational acceleration (ms$^{-2}$)			& $g$ 								& $10$  \\
kinematic viscosity (m$^2$s$^{-1}$)			& $\nu$								& $10^{-6}$  \\
thermal diffusivity (m$^2$s$^{-1}$)					& $\kappa$ 					& 0  \\
thermal expansion coefficient ($^\circ$C$^{-1}$)	& $\alpha$ 							& $10^{-3}$ \\ 
domain height (m)					& $H = 2h$							& $0.1$ \\ %\hline \hline
reduced gravity	(ms$^{-2}$)				& $g' = g\frac{\rho_1 - \rho_2}{\rho_0} = -g\alpha (T_1 - T_2)$	& $10^{-2}$  \\
buoyancy velocity					& $u_b = \sqrt{g'H}$ 						& $\sqrt{10^{-3}}$ \\
Grashof number						& $Gr = \left( \frac{h \sqrt{g'h}}{\nu} \right)^2$ 		& $1.25 \times 10^{6}$\\ \hline
\end{tabular}
\caption{Physical parameters for the lock-exchange set-up.}
\label{tab:le_physical_parameters}
\end{table}

\begin{table}[th]
\centering
\begin{tabular}[h]{lll}  \hline
Numerical component                           & Configuration                   & Section\\ \hline
Geometry                                      & from triangle file, via gmsh    & \ref{sect:triangle_format}, \ref{sect:meshing_tools_non_fluidity_gmsh}\\
Time step                                     & 0.025\,s                        & \\
Time loop                                     & 2 non-linear Picard iterations  & \ref{sect:ND_time_loop} \\
Equation of state                             & linear                          & \ref{sect:equation_of_state} \\
Momentum and Pressure spatial discretisation  & \Poo                            & \ref{Sect:ND_momentum_equation}, \ref{Sect:ND_pressure_equation}, \ref{sect:configuring_fluidity_continuous_galerkin}, \ref{sect:configuring_fluidity_pressure} \\
Momentum temporal discretisation              & $\theta = 0.5$ (Crank-Nicholson)  & \ref{sect:ND_time_theta_scheme}, \ref{sect:configuring_fluidity_temporal_discretisation} \\
                                              & non-linear relaxation term $=0.5$ & \ref{sect:relax} \\
Temperature advection                         & advection-diffusion equation    & \ref{Sect:MP-AdvdifEqn} \\
                                              & control volumes                 & \ref{Sect:CVs} \\
Temperature temporal discretisation           & $\theta = 0.5$ (Crank-Nicholson)& \ref{sect:ND_time_theta_scheme}, \ref{sect:configuring_fluidity_temporal_discretisation} \\
                                              & advection iterations, limit theta & ??? \\\hline
\end{tabular}
\caption{Numerical configuration for the lock-exchange}
\label{tab:le_numerical_configuration}
\end{table}

\subsection{Results} 
\label{sect:lock_exchange_results}

The expected dynamics of a lock-exchange flow are observed, figure \ref{fig:lock_exchange}: two gravity currents propagate in opposite directions with the foremost point of the no-slip front raised above the lower boundary. Kelvin-Helmholtz billows form at the interface leading to mixing of the two fluids which would not be observed with a hydrostatic formulation. The mesh adapts well, increasing the resolution around the interface and Kelvin-Helmholtz billows with anisotropic elements. Similar images can be generated by visualising the vtu files using Paraview or Mayavi2, see the \href{http://amcg-www.ese.ic.ac.uk/}{AMCG website}\ for more information.

Two diagnostics are considered. First the Froude number, $Fr = U/u_b$, is the ratio of speed, $U$, to the the buoyancy velocity, table \ref{tab:le_physical_parameters} is calculated. The speed with which the no-slip and free-slip fronts propagate along the domain, $U_{ns}$ and $U_{fs}$, are calculated from the model output and are used to give the corresponding no-slip and free-slip Froude numbers, $Fr_{ns}$ and $Fr_{fs}$, figure \ref{fig:lock_exchange_Fr}. For this basic set up the values are comparable to but generally smaller than previously published values, table \ref{tab:lock_exchange_Fr_comparison}. Spatially varying the horizontal velocity adaptivity settings as suggested in the Exercises, section \ref{sect:le_exercises}, can increase the Froude number, showing good agreement between the \fluidity\ values and previously published values. The second diagnostic, the ``domain fraction'', gives an illustration of the mixing taking place, \ref{fig:lock_exchange_mixing}. The temperature ($T$) range is divided into three classes: $T<-0.4$, $-0.4<T<0.4$ and $0.4<T$. For each class the fraction of fluid in the domain that has temperature within the given range gives the domain fraction. The class with range $-0.4<T<0.4$ is considered representative of the mixed fluid. As the simulation progresses, the amount of mixed fluid increases, more rapidly at first as Kelvin-Helmholtz billows form and just after the fronts hit the end wall. Later, as the dynamics become less turbulent and the fluid oscillates back and forth in the tank the mixing is less vigorous. The increase in mixed fluid is compensated for by a decrease in non-mixed fluid.

\begin{figure}[ht]
  \centering
  % For some reason tex4ht doesn't like these images.
  \onlypdf{
  \subfigure[$t = 0\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_0_T}}
  \subfigure[$t = 0\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_0_mesh_nice}} \\
  \subfigure[$t = 12.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_10_T}}
  \subfigure[$t = 12.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_10_mesh}} \\
  \subfigure[$t = 37.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_30_T}}
  \subfigure[$t =
  37.475\,$s]{\fig[width=0.45\textwidth]{./examples_images/lock_exchange/le_basic_30_mesh}}
  }
  \caption{Lock-exchange temperature distribution (colour) with meshes, over time ($t$)}
  \label{fig:lock_exchange}
\end{figure}

\begin{figure}[ht]
  \centering
  \fig[width=1.0\textwidth, clip=True, trim = 32.5mm 20mm 32.5mm 15mm]{./examples_images/lock_exchange/front_speed}
  \caption{Distance along the domain ($X$) and Froude number ($Fr$) for the no-slip and free-slip fronts in the lock-exchange.}
  \label{fig:lock_exchange_Fr}
\end{figure}

\begin{table}[th]
\centering
\begin{tabular}{|c|l|c|c|c|} \hline
& Reference 					& $Gr$ 			& no-slip $Fr$ 	& free-slip $Fr$	\\ [0.1ex] \hline
& Adaptive 1 (\fluidity)			& $1.25 \times 10^{6}$	& 0.381	        & 0.457			\\ [0.1ex]
& Adaptive 2 (\fluidity)			& $1.25 \times 10^{6}$	& 0.417	        & 0.482			\\ [0.1ex]\hline
\multirow{4}{*}{\begin{sideways}\parbox{18mm}{numerical}\end{sideways}} &\cite{hartel_00}, 2D	& $1.25 \times 10^{6}$	& 0.406		& 0.477			\\ [0.1ex]
& \cite{fringer_06}, 2D		                & $1.25 \times 10^{6}$ 	& 0.397 	& 0.428 		\\ [0.1ex]
& \cite{cantero_07}, 3D	                        & $1.50 \times 10^{6}$	& 0.407		& 			\\ [0.1ex]
& \cite{elias_08}, 3D		                & $1.50 \times 10^{6}$	& 0.409		&			\\ [0.1ex] \hline
\multirow{4}{*}{\begin{sideways}\parbox{19.5mm}{experiment}\end{sideways}}& \cite{keulegan_57} & $7.16 \times 10^{7}$ & 0.440&	\\ [0.1ex]
& \cite{britter_78} 	                        & $6.3 \times 10^{7}$	& 	 	& 0.518		 	\\ [0.1ex]
& \cite{simpson_79}                             & $4.8 \times 10^{6}$   & 0.432	        &	 		\\ [0.1ex]
& \cite{shin_04}			        & $>5 \times 10^5$	& 0.464		&			\\ [0.1ex] \hline
\multirow{2}{*}{\begin{sideways}\parbox{11.5mm}{theory}\end{sideways}} & \cite{benjamin_68} &	inviscid	&  & 0.5	\\[0.1ex]
& \cite{klemp_94} 		                &	inviscid	& 		& 0.527			\\ [1.0ex]\hline
\end{tabular}
\caption{Comparison of \fluidity\ Froude numbers with previously published results. \newline Adaptive 1: basic set up as described \newline Adaptive 2: setup with spatially varying interpolation error for the horizontal velocity as suggested in the Exercises, section \ref{sect:le_exercises}.}
\label{tab:lock_exchange_Fr_comparison}
\end{table} 

\begin{figure}[ht]
  \centering
  \fig[width=0.6\textwidth, clip=True, trim = 32.5mm 20mm 32.5mm 20mm]{./examples_images/lock_exchange/mixing}
  \caption{Time evolution of fraction of domain that contains fluid in three temperature classes.}
  \label{fig:lock_exchange_mixing}
\end{figure}

\subsection{Exercises}
\label{sect:le_exercises}
To explore the functionality of \fluidity, the following variations on this example would be constructive learning exercises:
\begin{itemize}
\item Run from the checkpoint to look at the mixing later in the simulation, section \ref{sect:configuring_fluidity_checkpointing}
\item In the adaptivity settings include a spatially varying interpolation error for the horizontal velocity and compare Froude numbers (python can be found in the comment section for the velocity adaptivity settings), section \ref{sect:configuring_fluidity_error_metric}
\item Change the frequency of the adapt, section \ref{sect:configuring_fluidity_adaptivity_options}
\item Turn on metric advection, section \ref{sect:configuring_fluidity_metric_advection}
\item Change the diffusivity and viscosity values
\item Run with a fixed mesh (note this will require making a new input mesh), sections \ref{sect:triangle_format}, \ref{sect:meshing_tools_non_fluidity_gmsh}
\item Try adding some detectors to visualise the particle trajectories, section \ref{sect:diagnostics_detectors} or \newline cf. \option{\ldots/fluidity-longtests/lock\_exchange\_2d\_}
\end{itemize}
Note to compare Froude numbers and mixing between different runs the remember to copy the images otherwise they will be overwritten.

% \subsection{Lagrangian trajectories illustrated in the lock-exchange}
% \label{sect:lock_exchange_Lagrangian_trajectories}
% Lagrangian trajectories from moving or Lagrangian detectors have been calculated in a lock-exchange test case. The test case can be found in \option{\ldots/fluidity-longtests/lock\_exchange\_2d\_} \\ \option{Lagrangian\_paths}. The domain of the 2D rectangular box is in this case $-5\leq x \leq 5\,$m and $-0.5 \leq z \leq 0.5\,$m. In this case a free-slip boundary condition is applied to the top and bottom of the domain ($w = 0$) and also to the end walls ($u = 0$).
% Also, the denser (cooler) fluid is now on the right ($0<x \leq 5\,$m) as opposed to the previous example. This can be observed in Figure \ref{fig:lock_exchange_Lag_traject_Temp_mesh}, where the Temperature distribution and the adapted mesh at two different times are displayed.
% 
% Figure \ref{fig:lock_exchange_Lagrangian_trajectories} illustrates the Lagrangian trajectories from three particles initially at three different positions in the interface between the fluids.
% 
% \begin{figure}[ht]
%   \centering
% \begin{minipage}{1\linewidth}
%   \fig[width=0.48\textwidth]{./examples_images/lock_exchange/Temp_at_1000vtu}
%   \fig[width=0.48\textwidth]{./examples_images/lock_exchange/Mesh_adaptivity_at_1000vtu}
% \end{minipage}\\
% \begin{minipage}{1\linewidth}
% \vspace{0.5cm}
%   \fig[width=0.48\textwidth]{./examples_images/lock_exchange/Temp_at_1500vtu}
%   \fig[width=0.48\textwidth]{./examples_images/lock_exchange/Mesh_adaptivity_at_1500vtu}
% \end{minipage}
%   \caption{Lock-exchange temperature distribution and meshes at two different instants in time}
%   \label{fig:lock_exchange_Lag_traject_Temp_mesh}
% \end{figure}
% 
% %\vspace*{-1.8cm}
% 
% \begin{figure}[ht]
%   \centering
% \vspace*{-2.6cm}
%   \fig[width=0.6\textwidth]{./examples_images/lock_exchange/Lag_paths_lock_exchange_labels}
% \vspace{-2.8cm}
%   \caption{An example of Lagrangian trajectories in a lock-exchange. Note that in this test case the denser fluid is on the right as opposed to the lock-exchange test case from Figure \ref{fig:lock_exchange} where the denser fluid is on the left. Here, the denser fluid flows below the lighter from right to left. The particles presented at initially three different positions in the interface between the fluids, follow the vortical structures resulting from the shear instability in the interface.}
%   \label{fig:lock_exchange_Lagrangian_trajectories}
% \end{figure}
% 
% Note that the results indicated in Figures \ref{fig:lock_exchange_Lag_traject_Temp_mesh} and \ref{fig:lock_exchange_Lagrangian_trajectories} have been calculated with a time step $\Delta t$=0.1 s. This is a large time step for this simulation but has been chosen for this test case since it runs faster and illustrates the Lagrangian trajectories. However, when accuracy is sought, it is recommended to use a smaller time step, i.e., $\Delta t$=0.01 s.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------ADVECTION--------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Advection example}
\label{sect:advection}

In this problem the advection of a passive tracer by a prescribed velocity field is considered.
The problem is taken from \cite{hanert2004}, see also \cite{hecht2000}. The problem domain
is an $L\times L$ box with $L=\km[1000]$. The prescribed velocity field is obtained from the
Stommel streamfunction
\begin{equation*}
\Psi(x,y) = \frac{FL}{\pi \gamma \rho H}\sin\left(\frac{\pi y}{L}\right)\left(p e^{Ax} + q e^{Bx}-1\right),
\end{equation*}
\begin{equation*}
p = 1-q = \frac{1-e^{LB}}{e^{LA}-e^{LB}},\quad
A=-\frac{\alpha}{2}+\sqrt{\frac{\alpha^2}{4}+\left(\frac{\pi}{L}\right)^2},\quad
B=-\frac{\alpha}{2}-\sqrt{\frac{\alpha^2}{4}+\left(\frac{\pi}{L}\right)^2}.
\end{equation*}
where the magnitude of the wind stress is $F = \Nmm[0.1]$, the frictional
coefficient is $\gamma = \invs[10^{-6}]$, the density is $\rho = \kgmmm[1000]$, the
fluid depth is $H=\m[200]$ and $\alpha = \beta/\gamma$ is chosen such that $\alpha^{-1}=\km[100]$.

The initial condition for the passive tracer is given by the Gaussian function:
\begin{equation}
s_0(x,y) = 10\exp\left({-\frac{(x-2L/3)^2 + (y-L/3)^2}{(L/50)^2}}\right).
\label{eqn:guassian}
\end{equation}

The reference solution at time $t$ used to compare numerical results against
is constructed as follows.  The ordinary differential equation (ODE) system
$\dot{\pmb{x}}=\pmb{u}$ is integrated repeatedly from time $t$ to $0$, with
initial condition given by the node positions on the mesh at time $t$.  This
yields the departure point, at time $0$, for each node on the current mesh.
The reference solution is found by evaluating the function
(\ref{eqn:guassian}) at these departure points.  Integration of the system
of ODEs for departure points is computed using the SciPy (Scientific tools
for Python) odeint function, which itself is a wrapper around the LSODE ODE
solver \cite{hindmarsh1983}.

In this example equation (\ref{PDE}) with $\kappa = 0$ is solved for the evolution of the tracer field until a
time of $\s[10^7]$ . The time step is taken to be $\s[1000]$ and $\theta=0.5$.
For the adaptive simulations the mesh is adapted every 20 time steps.
Linear interpolation is again used to transfer the solution field between adapted meshes.

\subsubsection{Results}

Figure \ref{fig:stommel_fix} shows results at four time levels for three
different fixed uniform isotropic mesh resolutions. Figures \ref{fig:stommel3}
and \ref{fig:stommel4} show the corresponding results computed with anisotropic
adapted meshes. Figure \ref{fig:stommel4} shows the results using a lower interpolation
error in the construction of the metric and hence has higher resolution. While there
are some qualitative differences between the results from the highest resolution fixed
mesh results in figure \ref{fig:stommel_fix} with those shown in figure \ref{fig:stommel3},
the differences are minimal compared with figure \ref{fig:stommel4}.

For quantitative comparison between the fixed and adapted mesh results figures \ref{fig:Stommel2Errors}
and \ref{fig:Stommel2_L2_Errors} show the time evolution of the maximum value of the advected field,
for which the analytical solution preserves a value of ten,
and the relative \Ltwo norm \cite{hanert2004} of the difference between the numerical and the reference
solution whose construction is described above. The results from figures \ref{fig:stommel3} and \ref{fig:stommel4}
correspond to the lowest and middle resolution adaptive results in figures \ref{fig:Stommel2Errors} and
\ref{fig:Stommel2_L2_Errors}.


%\begin{figure}
%\centering
%\subfigure{
%\fig[width=2.95cm,clip]{images/Adapt_C_2}}
%\subfigure{
%\fig[width=2.95cm,clip]{images/Adapt_C_10}}
%\subfigure{
%\fig[width=2.95cm,clip]{images/Adapt_C_12}}
%\subfigure{
%\fig[width=2.95cm,clip]{images/Adapt_C_20}}
%\caption{Adapted mesh (top) and isolines of the tracer field
%in the advection through a Stommel gyre simulation (section 3(b)) at
%(left to right) time levels $1,5,6,10\times 10^6$s. This simulation uses a tighter tolerance in the definition
%of the metric compared to those results presented in figure \ref{fig:stommel3}.
%At each time level there are 2397, 10433, 9893, 4303 nodes respectively which were obtained from a metric (\ref{eqn:ME}) with $\epsilon_u=0.05$.
%The maximum value for the tracer field at each time level is 9.76, 9.50, 9.46, 9.35 respectively.}
%\label{fig:stommel4}
%\end{figure}

The fixed mesh results can be seen to diffuse more than the adaptive mesh
when the tracer is close to the western boundary current, even for the highest resolution mesh
where over $150\,000$ nodes are used. The adaptive mesh results lose
some of the initial magnitude in the tracer field at the start of the simulation due to the resolution of the
initial mesh used before the first adapt, i.e. in the first 20 time steps.
Improved results would be obtained if a higher resolution initial mesh was used,
or if the mesh was adapted at the start of the simulation to better represent the initial condition.
At the end of the simulated time the magnitude of the tracer field for the highest resolution mesh ($157\, 045$ nodes)
can be seen to have dropped to below that of the middle adaptive resolution simulation, which corresponds to
figure \ref{fig:stommel4}, i.e. ($4303$ nodes).

%\begin{figure}
%\centering
%\fig[width=12.5cm,clip]{images/Stommel2Errors}
%\caption{Left: Maximum value of the advected field in the fixed isotropic mesh simulations for problem 3(b).
%The upper, middle and lower lines correspond to the fine
%($157\,045$ nodes), medium ($39\,490$ nodes) and coarse ($10\,056$ nodes)
%scale meshes respectively. The maximum value for the medium and coarse resolution at the end of the simulated time
%are 7.94 and 5.67 respectively. Middle: Maximum value of the advected field in the adaptive mesh simulations;
%the lines (top-bottom) correspond to the five interpolation errors used, the
%variation in time of the number of nodes in these simulations is shown in the panel on the right
%with the upper line corresponding to the lowest interpolation error and the upper line in the middle panel,
%and so on. The maximum number of nodes used in the highest resolution adaptive simulation is
%$41\,778$ and occurs at time $5.3\times 10^6$s.}
%\label{fig:Stommel2Errors}
%\end{figure}

In the adaptive mesh results the number of nodes used increases as the tracer field
enters the western boundary current, this is due to the gradients (and curvatures)
increasing as the tracer field is stretched, the number of nodes then decreases as
the tracer field leaves the western boundary current region and the simulation becomes
less computationally demanding. This demonstrates an important capability of adaptive methods,
the ability to remove resolution where it is no longer required.

The loss in magnitude of the tracer can be seen to be most significant while the
tracer field is in the western boundary current region, this is due to the resolution
being comparably lower as the scale of the advected field reduces, hence numerical
diffusion increases. The effect is lower in the adaptive simulations as the mesh resolution is increased
more significantly in this area at this time.

These results are consistent with the error plots in figure \ref{fig:Stommel2_L2_Errors}.
The errors grow more rapidly when the tracer is being advected through the western boundary current.
This is the case for both fixed and adaptive mesh results, where again the highest fixed resolution
mesh results match most closely those obtained from the middle adaptive mesh simulation (figure \ref{fig:stommel4}),
i.e. using over an order of magnitude fewer nodes.

With both the \Ltwo error and the maximum value of the advected field, the fixed mesh results
actually tend to perform better before and after the tracer is passing through the western boundary current.
For example, as can be seen from the growth rates of the plotted lines in figures \ref{fig:Stommel2Errors} and \ref{fig:Stommel2_L2_Errors}
 at the start and end of the simulation. The adaptive mesh runs perform better, in terms of
growth of errors, when the problem becomes more challenging numerically and the model is able to automatically use
increased anisotropic resolution close to the western boundary.

%\begin{figure}
%\centering
%\fig[width=8cm,clip]{images/Stommel2_L2_Errors}
%\caption{Relative \Ltwo norm of error between the numerical and reference solutions (for problem 3(b))
%plotted against time using left: fixed uniform mesh and right: adapted meshes.
%Each line, with decreasing error, corresponds to a mesh with increased number of nodes. The details
%of the meshes are the same as those described in the caption to figure \ref{fig:Stommel2Errors}.}
%\label{fig:Stommel2_L2_Errors}
%\end{figure}

The computational cost of the metric construction and the mesh optimisation procedure are approximately
equal for this problem. When combined they correspond approximately to the time taken for the model
to complete 3 time steps for this problem. Hence, the computational overhead of adaptivity can be estimated
at 15 percent of total run time. The middle adaptive mesh simulation (corresponding to figure \ref{fig:stommel4})
uses a maximum number of nodes which corresponds closely to the number used by the coarsest fixed mesh simulation.
However, the adaptive simulation runs approximately 60 percent faster than the fixed mesh simulation.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------LID DRIVEN CAVITY---------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Lid-driven cavity}
\label{sect:lid_driven_cavity}

\subsection{Overview}
The lid-driven cavity is a problem that is often used as part of the verification procedure for
CFD codes. The geometry and boundary conditions are simple to prescribe and in
two dimensions there are a number of highly accurate numerical benchmark solutions
available for a wide range of Reynolds numbers \citep{botella1998,erturk2005,bruneau2006}. 
Here the two-dimensional problem at a Reynolds number of 1000 is given as an example.

\subsection{Configuration}
The problem domain is $(x,y) \in [0,1]^2$ and this is represented by an unstructured triangluar mesh
of approximately uniform resolution. To enable convergence analysis a sequence of meshes are considered
with spacing of $h=1/2^n$, $n=4,5,6,7$. The two-dimensional incompressible Navier-Stokes equations are
considered with unit density.

No-slip velocity boundary conditions are imposed on the boundaries $x=0,1$ and $y=0$, 
and the prescribed velocity $u=1$, $v=0$ are set on the boundary $y=1$ (the `lid'). 

Here the problem is initialised with a zero velocity field and the solution
allowed to converge to steady state via time-stepping. The steady state convergence criterion is
that in the infinity norm the velocity varies by less that $10^{-6}$ between time levels.

The time step is constant between all runs, $\Delta t = 0.05$, and data is dumped to disk every
1.0 time units (20 time steps). The Crank-Nicolson $(\theta=0.5)$ discretisation is used in time. 
A \Poo Galerkin method is used for the discretisation of velocity and pressure, with no stabilisation
of velocity. Based on a domain size of $L=1.0$ and a velocity scale taken from the lid $(U=1.0)$, to achive
a Reynolds number of 1000 viscosity is taken to be isotropic with a value of $\nu=0.001$.

 

\begin{figure}
\centering
\subfigure{
\includegraphics[width=7cm,clip]{examples_images/driven_cavity_2d/driven_cavity_streamfunction.png}}
\subfigure{
\includegraphics[width=7cm,clip]{examples_images/driven_cavity_2d/driven_cavity_vorticity.png}}
\caption{Diagnostic fields from the lid-driven cavity problem at steady state at $1/128$ resolution.
Left: the streamfunction. Right: the vorticity. The contour levels are taken from those given by \cite{botella1998} in their tables
7 and 8.}
\label{fig:driven_cavity1}
\end{figure}


\subsection{Results}
Plots of the streamfunction and vorticity from the $h=1/128$ simulation are shown in figure \ref{fig:driven_cavity1}.
Observe the good qualititative agreement with \citep{botella1998,erturk2005,bruneau2006}. 
For a quantitative comaprison we take advantage of the tabulated benchmark data available in these papers.
Only a subset of these are computed: the $u$ velocity at a series of points along the line $x=0.5$ and the
$v$ velocity at a series of points along the line $y=0.5$ from \citep{erturk2005}, the same quantities at
different points along the same lines as well as the pressure along both the $x=0.5$ and $y=0.5$ lines from 
\citep{botella1998}, and the kinetic energy and the minimum streamfunction value from \citep{bruneau2006}.
The RMS difference in the case of the first six sets of benchmark data are taken with values extracted from 
the numerical solution, and the absolute difference taken in the final two. These eight error values are
defined as error1, \ldots error8 respectively and and plotted for the four mesh resolutions in figure 
\ref{fig:driven_cavity2}.
Second order spatial convergence can clearly be seen.
Adaptive refinement is not particularly advantageous for the problem at this reasonably low Reynolds number, but
yields significant improvements in efficiency at higher Reynolds number where boundary layers and
recirculating eddies are more dynamic, anisotropic and smaller in size compared to the entire domain.

\begin{figure}
\centering
\includegraphics[width=10cm,clip]{examples_images/driven_cavity_2d/driven_cavity_error_plot.png}
\caption{Convergence of the eight error metrics computed for the lid-driven cavity problem with mesh spacing. The eight
metrics are described in the text.}
\label{fig:driven_cavity2}
\end{figure}

\subsection{Exercises}
\begin{enumerate}
\item Examine the way that the $u=1$ lid condition is applied in the flml file. Why has it not been set as simply a constant?
Try changing it to a constant and see what happens to the errors that you achieve. [Hint: some people consider to "regularised" 
lid-driven cavity problem, try finding some papers that discuss this, try updating the boundary condition so it matches the 
regularised problem and compare to benchmark data if you can find it].
\item The references given above include data from other Reynolds numbers. Try updating the problem set-up and the python which computes
the errors for a higher Reynolds number.
\item Try switching on mesh adaptivity. Test adapting based on different metrics, e.g. try weighting $u$, $v$ and $p$
differently and see what meshes you get. Try varying these weights as well as the maximum and minimum allowed element
sizes to see how they affect each other and the mesh that results. Can you get a metric that results in a lower
error for the same number of nodes compared to the fixed mesh [Hint: it may be easier to achieve this at higher Reynolds numbers].
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------BACKWARD FACING STEP------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Backward facing step}
\label{sect:backward_facing_step}


\subsection{Overview}
The backward-facing step is a classical CFD example and one of the most frequently selected
problems for simulating the separation and reattachment of turbulent flows.
It is also often used as a test problem for validating and benchmarking numerical codes.
At high Reynolds numbers and in three spatial dimensions the problem has substantial
computing requirements, this makes it an ideal HPC benchmark problem for use here.
In the context of ocean modelling flow separation is important
in large scale western boundary currents such as the Gulf Stream.

Accurate experimental results for a wide range of flow regimes exist
(e.g. see \cite{armaly1983}) and the problem has several important flow
characteristics, such as the downstream length at which the flow reattaches
with the bottom of the domain.


\subsection{Configuration}
\subsubsection{Geometry}
A schematic of the domain is shown in figure \ref{Fig:Schematic}.
An inflow is imposed at the left hand boundary and encounters a step
down in the geometry. The region directly downstream of the step is
of particular interest in this problem. An outflow boundary is located at the
right hand end of the geometry.

%\begin{figure}
%\centering
%\fig[width=12.0cm]{images/BackwardStep-schematic.pdf}
%\caption{Schematic of the domain for the three-dimensional flow past a backward facing step
%problem.}
%\label{Fig:Schematic}
%\end{figure}

Following \cite{le1997} the length scales are given by: $L_x=30$, $L_i=10$, $L_y=4$, $h=1$, $L_z=6$,
so that $L_z-h=5$ and the expansion ratio is $L_z/(L_z-h)=1.2$.
The base of the domain is located at $z=0$, the inflow plane is given by $x=-10$ with the step
at $x=0$, and the back of the domain in the spanwise direction is given by $y=0$.

Note that the choice of an expansion ratio
of 2 is also common in the literature, where the upper boundary in that case is often treated as no-slip.


\subsubsection{Initial and boundary conditions}
The inflow boundary condition at $x=-10$ is given by
\begin{equation}
u(z) = \frac{u_{\tau}}{\kappa} \log \left(\frac{z - h}{z_0}\right), \quad v = w = 0,
\end{equation}
with parameters $u_{\tau} = 0.1$, $z_0 = 0.01$, $\kappa = 0.41$, and $u(z)$ set to zero for
$z<h+z_0$.
A plot of this inflow profile is given in figure \ref{Fig:Inflow}.

%\begin{figure}
%\centering
%\fig[width=8.0cm]{images/StepInflow.pdf}
%\caption{Inflow profile.}
%\label{Fig:Inflow}
%\end{figure}

No-normal flow, free-stress boundary conditions are applied at the upper and lateral
(spanwise) boundaries:
\begin{eqnarray*}
&&w=0,\quad \frac{\partial u}{\partial z} = \frac{\partial v}{\partial z} = 0 \quad\textrm{--- upper boundary},\\
&&v=0,\quad \frac{\partial u}{\partial z} = \frac{\partial w}{\partial z} = 0 \quad\textrm{--- lateral boundaries}.
\end{eqnarray*}

Free-stress boundary conditions are applied at the outflow boundary boundary:
\begin{equation*}
\frac{\partial u}{\partial x} = \frac{\partial v}{\partial x} = \frac{\partial w}{\partial x} = 0.
\end{equation*}

No-slip boundary conditions are applied at the bottom of the domain and at the step down:
\begin{equation*}
u=v=w=0.
\end{equation*}




\subsection{Results}
Three snapshots of the velocity vectors from the small benchmark run
are shown in figure \ref{Fig:Vectors} at times
5, 25 and 50. A vertical slice through the centre of the domain and a horizontal slice
at the level of the step are shown.


%\begin{figure}
%\centering
%\subfigure{\fig[width=15.0cm]{images/VectorSlice_10.pdf}}
%\subfigure{\fig[width=15.0cm]{images/VectorSlice_50.pdf}}
%\subfigure{\fig[width=15.0cm]{images/VectorSlice_100.pdf}}
%\caption{Snapshots of the velocity fields at times 5, 25 and 50 time units (top to bottom) into the simulation
%from the smaller benchmark run.
%A vertical slice through the centre of the domain and a horizontal slice at the height
%of the step are shown. The evolution of the dynamics can be seen, in particular the onset of fully
%three-dimensional structures and the reattachment of the velocity with the bottom of the domain approximately
%8 units downstream of the step.}
%\label{Fig:Vectors}
%\end{figure}


As this is a highly turbulent problem, making quantitative comparisons of
individual snapshots is impossible. However, time-averaged quantities are of diagnostic interest.
Figure \ref{Fig:TimeAverage} shows 3 snapshots of the $u$ component of velocity from the large
benchmark run and a time
averaged field. The removal of fluctuating components in the velocity field can be seen.

%\begin{figure}
%\centering
%\subfigure{\fig[width=15.0cm]{images/Velocity1.pdf}}
%\subfigure{\fig[width=15.0cm]{images/Velocity33.pdf}}
%\subfigure{\fig[width=15.0cm]{images/Velocity64.pdf}}
%\subfigure{\fig[width=15.0cm]{images/VelocityAverage.pdf}}
%\caption{Snapshots of the $u$ velocity components at three time slices (top three frames) and the
%average field from 64 input snapshots spaced equally between times 70 and 102 (bottom).
%Contours are displayed at the $-0.05$, $0.0$, $0.05$, $0.1$, $0.5$ and $1.0$ levels.}
%\label{Fig:TimeAverage}
%\end{figure}



One of the metrics most often considered is the point at which the flow which separates from the step
reattaches to the bottom of the domain. The length downstream of the step at which this happens
has been found from laboratory experiments and direct numerical simulations and is considered a
sensitive measure of the quality of the numerical method. It is typically used to examine the impact
of turbulence parameterisations and here will be used to examine this in addition to the use of mesh
adaptivity to simulate this problem.

The reattachment length was defined here to be the length
from the step at which the zero-isosurface of the $x$-component of $\vec{u}$ intersects with
the bottom boundary. This quantity was computed from $\vec{u}$
using the VTK library. For the simulation described, the reattachment
length was approximately 10 times the step height, which is consistent with the value
given in the literature \cite{le1997}.
The precise value for the reattachment length is dependent on exact configuration on the domain and inflow
conditions, and also strongly on the Reynolds number of the flow.
A more rigorous analysis would involve
repeating the experiment for a range of Reynolds numbers and comparing the reattachment
length of multiple model runs. It may be seen that pseudo-supermeshing is an efficient
method to produce a common mesh suitable for the interpolation of fields from multiple
meshes, such as is necessary in time-averaging.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%----------------------Sphere------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Flow past a sphere: drag calculation}

In this validation test uniform flow past an isolated sphere is simulated
and the drag on the sphere is calculated and compared to a curve optimised
to fit a large amount of experimental data.

The sphere is of unit diameter centred at the origin. The entire domain is
the cuboid defined by $-10\le x\le 20$, $-10\le y\le 10$, $-10\le z\le 10$.
The unsteady momentum equations with nonlinear advection and viscous terms
along with the incompressibility constraint are solved. Free slip velocity
boundary conditions are applied at the four lateral boundaries, $u=1$ is
applied at the inflow boundary $x=-10$, and a free stress boundary condition
applied to the outflow at $x=20$. A series of Reynolds numbers in the range
$Re\in [1,1000]$ are considered. The problem is run for a long enough
period that the low Reynolds number simulations reach steady state, and the
higher Reynolds number runs long enough that a wake develops behind the
sphere and boundary layers on the sphere are formed.  This is deemed
sufficient for the purposes of this test which is not an in-depth
investigation of the physics of this problem, nor an investigation of the optimal
set of numerical options to use.  Here an unstructured
tetrahedral mesh is used along with mesh optimisation (adaptivity). 
Figure \ref{fig:drag} shows a snapshot of the
mesh and velocity vectors taken from a Reynolds number 1000 simulation. The
mesh can be seen to be resolving the wake and the boundary layers on the
sphere with enhanced anisotropic resolution. At higher Reynolds numbers the
dynamics become more complex and if a full numerical study was being
conducted here more care would be taken is the choice of mesh optimisation
parameters and the use of averaged values from simulations allowed to run
for longer periods. The drag coefficient is calculated from
\begin{equation}
C_D = \frac{F_x}{\frac{1}{2}\rho u_0^2 A},\qquad F_x = \int_S (n_xp - n_i\tau_{ix})\;dS,
\end{equation}
where $\rho$ is the density, taken here to be unity; 
$u_0$ is the inflow velocity, here unity; 
and $A$ is the cross-sectional area of the sphere, here $\pi^2/4$. 
$F_x$ is the force 
exerted on the sphere in the free stream direction;
$S$ signifies the surface of the sphere; $n$ is the 
unit outward pointing normal to the sphere 
($n_x$ is the $x$-component and $n_i$ the $i^{\textrm{th}}$ 
component, here summation over repeated indices is assumed); 
$p$ is the pressure and $\tau$ is the stress tensor;
see \citet{panton2006}.

Figure \ref{fig:drag} also shows a comparison between the computed drag coefficient with
a correlation (to a large amount of laboratory data) taken from \citet{brown2003}:
\begin{equation}
C_D = \frac{24}{Re}\left(1+0.15Re^{0.681}\right) + \frac{0.407}{1+\frac{8710}{Re}}.
\label{drag_corr}
\end{equation}

The assertions tested are that the difference between
the computed drag coefficient and values from the correlation 
(\ref{drag_corr}) at a number of Reynolds numbers are within acceptable bounds.
Checks on the number of nodes produced by the adaptive algorithm for 
given error measure choice and other options are also conducted. While
all of these simulations can be run comfortably in serial, the Reynolds 
number 100 and 1000 cases are performed on 8 cores both to accelerate the 
tests and as a test of the parallel implementation.

%\begin{figure*}
%\vspace*{2mm}
%\begin{center}
%\includegraphics[width=12cm]{images/Drag-combined}
%\includegraphics[width=5.5cm]{images/Sphere_Drag}
%\end{center}
%\caption{Left: Unstructured adapted mesh from flow past a sphere simulation at Re=$10^3$,
%with insets showing the mesh and velocity vectors in a blown up region close to the sphere. 
%Right:
%Comparisons between the computed drag coefficient (circles) and the correlation (solid line) given by expression
%(\ref{drag_corr}) in the range $Re\in [1,1000]$.}
%\label{fig:drag}
%\end{figure*}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%----------------------CHANNEL------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Rotating periodic channel}
\label{sect:periodic_channel}

\subsection{Overview}

This problem provides a convergence test for the \PoDGPt\ element pair.
Utilising almost all the terms of the incompressible Navier-Stokes equations
in two dimensions.

The domain is a unit square which is periodic in the zonal direction. The
North and South boundaries are zero slip (i.e. $\vec{u}=0$). The remaining
parameters are as follows:

\begin{tabular}{lll}
  Coriolis parameter & $f$ & $1$ \\
  Viscosity & $\nu$ & $1$ 
\end{tabular}

The flow is driven by a velocity source term:
\begin{equation}
  \vec{F}=
  \begin{bmatrix}
    y^3 \\
    0
  \end{bmatrix}
\end{equation}

So the whole system of equations becomes:
\begin{gather}
  \ppt{u}+u\ppt[x]{u}-v=-\grad p + \grad^2 u +y^3\\
  \ppt{v}+v\ppt[y]{v}+u=-\grad p + \grad^2 v\\
  \div\vec{u}=0
\end{gather}

This system has a steady solution at:
\begin{gather}
  \vec{u}=
  \begin{bmatrix}
    \frac{1}{20}(y-y^5)\\
    0
  \end{bmatrix}\\
  p=\frac{1}{120}y^6-\frac{1}{40}y^2+C
\end{gather}
Where $C$ is an arbitrary constant resulting from the use of Dirichlet
boundary conditions on both the domain boundaries.

\subsection{Results}

Since the maximum velocity in the domain is approximately 0.025, the
Reynolds number for this solution is much smaller than 1 so the flow is
safely within the laminar regime and will remain steady. Figure
\ref{fig:periodic_channel}\ shows the forcing term for velocity and the
analytic solutions for velocity and pressure.


\begin{figure}[htbp]
  \centering
  \onlypdf{\begin{pdfdisplay}}
    \psfrag{u source}{$\vec{u}$ source}
    \psfrag{u solution}{$\vec{u}$ solution}
    \psfrag{p solution}{$p$ solution}
    \psfrag{0}{0}
    \psfrag{0.2}{0.2}
    \psfrag{0.4}{0.4}
    \psfrag{0.5}{0.5}
    \psfrag{0.2}{0.6}
    \psfrag{0.8}{0.8}
    \psfrag{1}{1}
    \psfrag{y}{$y$}
    \psfrag{-0.01}{-0.01}
    \psfrag{-0.02}{-0.02}
    \psfrag{0.01}{0.01}
    \psfrag{0.02}{0.02}
    \psfrag{0.03}{0.03}
    \includegraphics[width=1.1\textwidth]{examples_images/rotating_channel/analytic_solution.eps}
  \onlypdf{\end{pdfdisplay}}
  \caption{Velocity forcing term and analytic solutions for velocity and
    pressure for the rotating periodic channel test case. Note that each of
    these quantities is constant in the $x$ direction.}
  \label{fig:periodic_channel}
\end{figure}

The convergence test is conducted by repeating this simulation on unstructured meshes
with typical resolution $1/4$, $1/8$, $1/16$, $1/32$, $1/64$. The results
are then compared to the analytic solution. In the case of pressure, the
answer is translated to account for the arbitrary constant. Figure
\ref{fig:periodic_channel_error}\ shows the $\textrm{L}^2$ error for
velocity and pressure. It is apparent that both quantities converge at
second order.

\begin{figure}[htbp]
  \centering
  \onlypdf{\begin{pdfdisplay}}
    \psfrag{u error}{$\vec{u}$ error}
    \psfrag{p error}{$p$ error}
    \psfrag{O\(dx^2\)}{$O(\d x^2)$}
    \psfrag{dx}{$\d x$}
    \psfrag{1.0e+00}{\small\hspace{1em}$1$}
    \psfrag{1.0e-01}{\small\hspace{1em}$10^{-1}$}
    \psfrag{1.0e-02}{\small\hspace{1em}$10^{-2}$}
    \psfrag{1.0e-03}{\small\hspace{1em}$10^{-3}$}
    \psfrag{1.0e-04}{\small\hspace{1em}$10^{-4}$}
    \psfrag{1.0e-05}{\small\hspace{1em}$10^{-5}$}
    \psfrag{1.0e-06}{\small\hspace{1em}$10^{-6}$}
    \includegraphics[width=1.1\textwidth]{examples_images/rotating_channel/convergence.eps}
  \onlypdf{\end{pdfdisplay}}  
  \caption{Error in the pressure and velocity solutions for the rotating channel as a function of resolution.}
  \label{fig:periodic_channel_error}
\end{figure}

\subsubsection{Exercises}

This example can be used to understand the use of analytic forcing
functions in \fluidity. Try modifying the function
\lstinline[language=python]{channel_viscous.forcing}. The forcing function
and the analytic velocity and pressure results can be visualised by running
the \lstinline[language=python]{plot_theory}\ script. 

Examine the rest of the \lstinline[language=python]{channel_viscous}\ Python
module to see how the analytic solution is automatically calculated from the
forcing function. Next, examine the \option{AnalyticUVelocitySolutionError}\
and \option{AnalyticPressureSolutionError} to see how this is used to
calculate the error in the model solution. The documentation of the Python
state interface in appendix \ref{chap:python}\ may be useful.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---------------------ANNULUS-------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Baroclinic Annulus}
\label{sect:annulus}

\subsection{Overview}

The rotating annulus is a classic laboratory scale analogue for large scale
geophysical flows and processes. It dates back to the PhD work of Raymond Hide,
originally developed as an analogue for Earth core dynamics \citep{hide1952} and only
later recognised for its relevant to atmospheric flows \citep{hide1953, hide2006}.
In contrast to earlier dish-pan type experiments \citep{fultz1951}, the rotating
annulus allows for rigorous reproducible experiments and was instrumental in the
development of the theory of deterministic chaos \citep{lorenz1963}.

The rotating annulus test problem is configured to simulate the classic
differentially heated baroclinic annulus. The dynamics
of this system are dependent upon a number of external parameters, most notably
the thermal Rossby (or Hide) number:

\begin{equation}\label{eqn:hide_number}
  \Theta = \frac{g \alpha \Delta T}{\Omega^2} \frac{d}{(b - a)^2},
\end{equation}

representing the relative strength of thermal forcing to rotation, and the Taylor number:

\begin{equation}\label{eqn:taylor_number}
  T = \frac{\Omega^2}{\nu^2} \frac{4(b - a)^5}{d},
\end{equation}

representing the relative strength of rotation to viscous dissipation (a rotational
Reynolds number \citep{lorenz1967}). Here $\Delta T$ is the thermal forcing, $d$ is the tank depth and $a$ and $b$
are the smaller and larger annulus radii respectively.

The system exhibits a range of dynamical regimes depending upon the external parameters.
In order of increasing rotation
rate these are, broadly speaking: geometrically modified natural convection,
axisymmetric Hadley regime, non-axisymmetric Rossby regime with fully developed
baroclinic waves, and geostrophic turbulence. See \citet{hide1975} and \citet{frueh1997}
for a more complete description.

The emergent regime is dependent upon a number of features of the flow. At
sufficiently high rotation rate (low Rossby number) the flow is, to leading
order, in thermal wind balance, with the dynamics being a small perturbation to
this background state. Furthermore, the dynamics of baroclinic instability are
highly dependent upon the representation of the active Ekman layers at the tank
base and lid \citep{hide1969}. It is therefore essential that a numerical model
of the rotating annulus be able to represent these processes with a high degree
of accuracy.

\subsection{Configuration}

The model parameters in the rotating annulus test problem have been chosen such
that one expects a baroclinically unstable flow with a steady dominant mode three
wave. Owing to hysteresis in the system these parameters are also consistent with
a dominant mode two wave.

The model is configured to use the \Poo velocity-pressure element pair with a \Ptwo
geostrophic pressure. Temperature is discretised via a control volume method using
the Sweby limiter. Dynamic mesh adaptivity is applied with all of velocity, pressure
and temperature interpolated via Galerkin projection. The simulation is initialised
with a linear stratification, and uses an initial mesh stretched in
the radial and azimuthal direction as described in \citet{farnell1975}. The
configuration uses an adaptive timestep targetting a CFL number of 1.0, and is
integrated for 600\s[] on 8 processes.

The test has a runtime of approximately 20 hours on cx1.

\subsection{Results}

At simulation end it is tested that a dominant mode three wave has developed,
although it is not expected that this wave will have equilibrated after this
length of simulated time. The heat transport of this system is compared against
the experimental value from \citet{read2003}. Other properties of the system,
including the integrated temperature, the temperature \Ltwo norm, the dominant
mode amplitude and the dominant mode drift rate are also measured and compared
against previous simulations for regression testing purposes.

\begin{figure}[ht]
  \centering
  \fig[width=0.48\textwidth]{./examples_images/annulus/TemperatureSlices}
  \caption{Vertical and horizontal cuts through the final temperature field
           for the baroclinic annulus test case. Normalised temperature
           $\bar{T} = T / \Delta T$.}
\end{figure}

\begin{figure}[ht]
  \centering
  \subfigure{\fig[width=0.46\textwidth]{./examples_images/annulus/ArrayHovmueller}}
  \subfigure{\fig[width=0.46\textwidth]{./examples_images/annulus/ArrayFft}}
  \caption{Left: Hovm\"uller plot of the mid-radius mid-height temperature field
           for the baroclinic annulus test case. Right: FFT of left, showing
           growth of the baroclinic modes and a final dominant mode three wave.}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%---Open ocean deep convection--------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Open ocean deep convection}
\label{sect:OODC}
\subsection{Overview}
Open-ocean deep convection (OODC) has been recognised as an
important mixing process for over 25 years, and
has been studied in the ocean, simulated in the laboratory, and modelled numerically.
A much-cited study in the field of numerically simulating
open-ocean deep convection is that of \cite{jones1993} and this is recreated here.
In their work, a fixed resolution ($240 \times 240 \times
100$m in $X, Y, Z$) model is used to study the physics and
characteristic scalings of OODC. Their simulations use a disc
of cooling in a simple box geometry to investigate the effects of rotation.

Ocean convection is important to the meridional overturning
circulation. It is a small scale non-hydrostatic process which
is difficult to capture in general circulation models. Applying
an unstructured adaptive mesh model to study this process is
novel, and this approach may produce new insights into the
simulation and parameterisation of convection in structures and
unstructured mesh models.

Although OODC itself is a small-scale process, it interacts with
processes on the basin-scale, both in the preconditioning stage and
in the sinking and spreading stages. It is therefore important for us
to be able to represent a large range of scales. Finite elements and adapting
unstructured meshes are particularly suited for this application, as the
resolution used can vary in size smoothly over a wide area.

\subsection{Configuration}

\subsubsection{Geometry}

%\begin{figure}
%\centering
%\fig[width=8.0cm]{images/oodc-schematic.pdf}
%\caption{Schematic of the domain for the three-dimensional open ocean deep convection
%problem.}
%\label{Fig:Schematic}
%\end{figure}


A schematic of the domain is shown in figure \ref{Fig:Schematic}.
The domain is 32km square in the horizontal and 2km deep. A cooling disk of radius
8km is centred at middle of the upper boundary.




\subsubsection{Parameters}
The thermal expansion coefficient is set to
$\alpha=2 \times 10^{-4} \,\mathrm{K}^{-1}$ and gravity to $g=9.81 \,\mathrm{m}\,\mathrm{s}^{-2}$.

The eddy viscosity
and thermal diffusivity were set to the same values as those
used in \cite{jones1993}: $\kappa_h = 5.0 \mathrm{m}^2\mathrm{s}^{-1}$ and
$\kappa_v = 0.2 \mathrm{m}^2\mathrm{s}^{-1}$.


\subsubsection{Initial and boundary conditions}
The domain is initialised at rest with a weak temperature stratification
in the vertical, with a top-to-bottom temperature difference of
$0.05\,$K.
This therefore corresponds to a buoyancy frequency ($N$) value
of $2.2 \times 10^{-4} \,\mathrm{s}^{-1}$.


A heat loss of $-800\,\mathrm{W}\,\mathrm{m}^{-2}$ is
applied as a flux boundary condition. Assuming density $\rho=1000\,\mathrm{Kg}\,\mathrm{m}^{-3}$,
specific heat capacity $c_p=4\times 10^3\,\mathrm{J}\,\mathrm{Kg}^{-1}\,\mathrm{K}^{-1}$,
the flux $q=\bmn\cdot\left ( \kaptens_T  \nabla T\right)$
takes the value $q = 2\times 10^{-4}\,\mathrm{K}\,\mathrm{m}^{-1}\,\mathrm{s}^{-1}$.
This value is applied in a disk of radius $7750\,\mathrm{m}$ with a linear ramp to zero flux to a radius
$8000\,\mathrm{m}$. In addition, this forcing is only applied for the first 48 hours of the simulation and
then switched off, so that the restratification stage of the problem can be considered.



No-normal flow, free-stress boundary conditions are applied at the upper and lateral
(spanwise) boundaries.


\subsection{Results}




\section{Water column collapse}

\subsection{Overview}
A commonly used validation experiment for multi-material models is that of a collapsing column of liquid, normally water, within an atmosphere or vacuum \citep{lakehal_interface_2002}, also known as the dam break problem.  In the experimental set-up a reservoir of water is held behind an impermeable barrier separating it from the rest of the tank.  The barrier is then quickly removed, allowing the water column to collapse and flood the remaining sections of the tank.  In the numerical analogue the initial condition is generally taken as the trapped water column, still behind the dam.  At the start of the simulation the barrier is imagined to have been removed instantaneously and switching on gravity, $|g| = 9.81$, causes the column to collapse.   Several experimental set-ups have been published and used as comparison and validation tools for numerical models \citep{martin_part_1952, greaves_simulation_2006}.  Those with water depth gauges distributed throughout the tank are particularly useful, allowing the direct comparison of data.  Furthermore, pressure gauges located on the tank walls or on any obstacles within the tank provide another useful validation tool.

In this example, \fluidity\ is used to simulate a simple dam break experiment \citep{zhou_nonlinear_1999}.  The example demonstrates the following functionality:

\begin{itemize}
\item 2D flow
\item Multi-material flow
\item Incompressible flow
\item Inviscid flow
\item Mesh adaptivity
\item Static detectors
\end{itemize}

The simulation illustrated here took $\sim$2 hours to run in serial on a Intel Xeon X5355 2.66 GHz processor.

\subsection{Problem specification}
The experiment on which this example is based was a simple dam break problem in a $3.22\times2\times1m$ (length $\times$ height $\times$ depth) tank \citep{zhou_nonlinear_1999}.  A reservoir of water $1.2\times0.6\times1m$ (length $\times$ height $\times$ depth) was held behind a barrier at one end of the tank.  Water depth gauges were placed at two points, marked H1 and H2 in Figure \ref{fig:zhouinitial}(a), at $x_1 = 2.725m$ and $2.228m$ respectively.  Additionally, a pressure gauge was located at the point marked P2 in Figure \ref{fig:zhouinitial}(a), at $x_2=0.16m$ on the wall facing the initial water column.

As no variations were introduced in the third dimension, the experiment is reproduced here numerically in two dimensions within the domain $\Omega$: $x_1 \in [0,3.22]$, $x_2 \in [0,2]$ \citep{lee_numerical_2002, colagrossi_numerical_2003, park_volume-of-fluid_2009}.  The two materials (water and air) are distinguished by scalar fields $\alpha_k$ representing their volume fraction, where the volume fraction of air $\alpha_2 = 1-\alpha_1$ and $\alpha_1$ is the volume fraction of water. The initial condition of the water volume fraction is shown in Figure \ref{fig:zhouinitial}(a).  The presence of water is indicated as a grey region and the interface to air is delineated by contours at volume fraction values of $0.025$, $0.5$ and $0.975$.  The densities of the water and air are taken as $ 1,000kg\,m^{-2}$ and $1kg\,m^{-2}$ respectively.  Both fluids are treated inviscidly. As the simulation is inviscid, free slip boundary conditions are imposed on the tank bottom, $x_2=0$, and sides, $x_1=0,\,3.22$.  The top of the tank, $x_2=2$, is left open.

\begin{figure}[tbp]
\hspace{1cm}(a)
\begin{center}
\input{examples_images/water_collapse/initial_setup.tex}
\end{center}
\hspace{1cm}(b)
\begin{center}
\includegraphics[width=10.2cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_0_mesh.pdf}
\end{center}
\caption{(a) Initial set-up of the water volume fraction, $\alpha_1$, and the velocity and pressure boundary conditions for the two-dimensional water column collapse validation problem \citep{zhou_nonlinear_1999}. The presence of water is indicated as a grey region and the interface to air is delineated by contours of the volume fraction at $0.025$, $0.5$ and $0.975$.  The locations of the pressure (P2) and water depth gauges (H1, H2) are also indicated. (b) The adapted mesh used to represent the initial conditions.}
\label{fig:zhouinitial}
\end{figure}

The water volume fraction, $\alpha_1$, is solved for using an advection equation (REFMARKER).  It is advected using HyperC on a control volume mesh (REFMARKER), while the velocity and pressure are discretised using the P0P1$_{\text{CV}}$ element pair (REFMARKER) with $\theta=1/2$ and $\theta_i=1/2$ (REFMARKER).  

This example employs an adaptive mesh (REFMARKER). The minimum edge length in the mesh is constrained to $2mm$. The upper bound on the edge lengths was specified as half the domain length and height in each dimension.  The pressure and water volume fraction were directly adapted to using interpolation error bounds, $\hat{\epsilon}$, of $1,000$ and $0.05$ respectively.  As the velocity is element centred it was first projected to the vertices before being adapted to with an interpolation error bound of $1$ for each component.  Given the ranges of these fields seen in the fixed mesh runs these correspond to desired errors of less than 5\% for each field. The volume fraction is transferred between successive meshes using a minimally diffusive bounded projection algorithm.  The velocity is transferred using a straightforward projection while the pressure is consistently interpolated using the linear basis functions from its parent mesh. For details of the remaining adaptivity settings we refer to the documented flml file.  The initial mesh using these settings is shown in Figure \ref{fig:zhouinitial}(b). 

The timestep is selected to achieve a Courant number (REFMARKER) of $2.5$ while the advection equation uses approximately $10$ subcycles (REFMARKER) so the volume fraction is advected at a Courant number of $0.25$.  

\subsection{Results}
Several timesteps of the example simulation can be seen in Figure \ref{fig:zhouwholea} where the interface is represented by contours of the water volume fraction, $\alpha_1$, at $0.025$, $0.5$ and $0.975$.  Similar images can be generated by visualising the vtu files using Paraview or Mayavi2 (REFMARKER).

\begin{figure}[tbp]
\begin{center}
% \newcolumntype{V}{>{\centering\arraybackslash} m{7cm} }
\begin{tabular}{ll}
(a) $t = 0.5$ & (b) $t = 1.0$   \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_100.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_200.png} \\
(c) $t = 1.5$ & (d) $t = 1.625$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_300.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_325.png} \\
(e) $t = 1.75$ & (f) $t = 1.875$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_350.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_375.png} \\
(g) $t = 2.0$ & (h) $t = 2.5$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_400.png} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_500.png} \\
\end{tabular}
\caption{The evolution of the water volume fraction, $\alpha_1$, over several timesteps.  The presence of water, $\alpha_1=1$, is indicated as a grey region and the interface to air, $\alpha_1=0$, is delineated by contours at $\alpha_1 = 0.025$, $0.5$ and $0.975$.}
\label{fig:zhouwholea}
\end{center}
\end{figure}

\begin{figure}[tbp]
\begin{center}
% \newcolumntype{V}{>{\centering\arraybackslash} m{7cm} }
\begin{tabular}{ll}
(a) $t = 0.5$ & (b) $t = 1.0$\\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_100_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_200_mesh.pdf} \\
(c) $t = 1.5$ & (d) $t = 1.625$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_300_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_325_mesh.pdf} \\
(e) $t = 1.75$ & (f) $t = 1.875$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_350_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_375_mesh.pdf} \\
(g) $t = 2.0$ & (h) $t = 2.5$ \\
\includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_400_mesh.pdf} & \includegraphics[width=7cm, trim=2.5cm 4.5cm 2.5cm 4.5cm, clip=true]{examples_images/water_collapse/water_collapse_500_mesh.pdf} \\
\end{tabular}
\caption{The evolution of the adaptive mesh over the same timesteps displayed in Figure \ref{fig:zhouwholea}.  The mesh can be seen to closely follow the interface between the water and air.}
\label{fig:zhouwholemesh}
\end{center}
\end{figure}

The images show the column collapse (Figure \ref{fig:zhouwholea}(a)), run-up against the opposing wall (Figure \ref{fig:zhouwholea}(b)) and the subsequent overturning wave (Figure \ref{fig:zhouwholea}(c, d)) and entrainment of air bubbles (Figure \ref{fig:zhouwholea}(e--h)).  

\begin{figure}[tbp]
\begin{center}
%\newcolumntype{V}{ m{7cm} }
\begin{tabular}{cc}
\hspace{1cm}(i) H1 & (ii) H2  \\
\includegraphics[width=7cm]{examples_images/water_collapse/water_gauge_H1.pdf} & \includegraphics[width=7cm]{examples_images/water_collapse/water_gauge_H2.pdf}\\
\end{tabular}
\caption{Comparison between the experimental (circles) and numerical water gauge data at H1 (i) and H2 (ii), $x_1 = 2.725m$ and $2.228m$ respectively.  The letters along the top of the graphs indicate the times corresponding to Figure \ref{fig:zhouwholea}(a--h).  Experimental data taken from \citet{zhou_nonlinear_1999} through \citet{park_volume-of-fluid_2009}.}
\label{fig:zhoudepth}
\end{center}
\end{figure}

For validation purposes, the post-processing script provided for this example extracts information from the detector file (pressure) and from the water volume fraction field stored in the vtu files (water depth) and plots these data in comparison with the experimental results. The water depth gauge data is displayed in Figure \ref{fig:zhoudepth} alongside the experimental data.  The numerical results show the total thickness of water at the points H1 and H2, discounting any air bubbles that cross the gauges.  The simulation results show a close similarity to the experimental results with the exception of a small lip of water when the initial water head passes the gauge.  It is unclear what causes this structure, though it may be related to the initial withdrawal of the barrier in the experiment or drag effects from the bottom of the tank.  All previous published attempts to model the experiment also fail to reproduce this initial lip \citep{zhou_nonlinear_1999, lee_numerical_2002, colagrossi_numerical_2003, park_volume-of-fluid_2009}.

After $t=1.5s$ the overturning wave starts to pass the water gauges and the match between the experimental results and the numerical simulation deteriorates. As would be expected from such complex behaviour, all previous published attempts have also failed to reproduce the experimental depth gauge data after this point.  However, the broad pattern and average depth observed in the simulation after $t=1.5s$ can be seen in Figure \ref{fig:zhoudepth} to match the experiment reasonably well.

\begin{figure}[tb]
\begin{center}
\includegraphics[width=10cm]{examples_images/water_collapse/pressure_gauge_P2.pdf}
\caption{Comparison between the experimental (circles) and numerical pressure gauge data at P2, $x_1 = 3.22m$, $x_2 = 0.16m$.  The letters along the top of the graphs indicate the times corresponding to Figure \ref{fig:zhouwholea}(a--h).  Experimental data taken from \citet{zhou_nonlinear_1999} through \citet{park_volume-of-fluid_2009}.}
\label{fig:zhoupressure}
\end{center}
\end{figure}

Experimental pressure gauge data are also available at the point P2, $(3.22,0.16)m$, on the right wall of the tank.  This is compared to the numerical pressure results in Figure \ref{fig:zhoupressure}.  After the initial noise in the experimental data, a sudden step in pressure is seen as the water run-up reaches the pressure gauge at about $t=0.6s$.  This is also seen in the numerical simulations however it is slightly delayed, occurring at $t=0.7s$.  As upwinding is being used in the discretisation of the velocity field, the delay may be due to numerical viscosity slowing the advancing water front.  However, as the delay was not as extreme at the depth gauges H1 and H2 other factors may also play a role.  For instance, if the lip seen in the experimental water gauge data is a head on the water front, that has not been reproduced numerically, it may reach the height of the pressure gauge faster than a front with no head.

Once the pressure jump occurs the experimental and numerical data are in broad agreement until the overturning wave impacts with the water layer at approximately $t=1.5s$ (Figure \ref{fig:zhouwholea}(c)).  At the point of contact a pressure pulse is transmitted to the pressure gauge resulting in a modest pressure spike in the experimental data.  This is matched by slightly delayed pressure pulses in all the numerical simulation.  However, the pulses seen in the numerical data are of a much larger magnitude than the experimental data. This discrepancy may be due to the fact that in the experiment the pressure gauge measures the pressure over a broader area than in the simulation. 

\subsection{Exercises}
To explore the functionality of \fluidity, the following variations on this example would be constructive learning exercises:

\begin{itemize}
\item Disable the adaptivity option to run on a fixed mesh
\item Alter the water/air viscosity/density
\item Modify the tank geometry
\end{itemize}

