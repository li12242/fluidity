\chapter{Getting started}\label{chap:gettingstarted}

\section{Introduction}
This first chapter gives a brief guide to setting-up, running and visualising
simulations.

\section{Obtaining Fluidity}
\label{sect:obtaining_fluidity}

\subsection{Overview}
\label{sect:obtaining_fluidity_overview}

Fluidity is primarily distributed as source code, which takes the form of
instructions that are passed through a compiler to generate binary files that
your operating system can run. If you come from a UNIX background you will
probably be used to this form of distribution; if however you come from a
Windows or Mac background you may be used to programs being distributed as
pre-compiled packages which you need do nothing more than put in place and run.
There are obvious benefits to the ready-to-run approach, namely that they do
not generally require you to install any more software other than the specific
program you want, and they have a very short lead-time before you are up and
running. However, there are a number of obvious disadvantages, particuarly that
making any changes to the program you have just received is extremely
difficult, and there is an underlying assumption that the computer you run the
program on will be substantially the same as the computer the program was
compiled on.

For the majority of Fluidity users the disadvantages of pre-compiled binaries
will outweight the benefits, and distribution of source code is the best
solution. Indeed, even if you receive a copy of Fluidity as a pre-compiled
binary, the licence (LGPL) under which Fluidity is distributed requires that
the original source code is also made available.

Fluidity is a very actively developed code, and at present the concept of
released versions is some way in the future. Thus, obtaining the source code to
Fluidity requires that you obtain the latest copy, for which a tool called
subversion is used. If you are not familiar with subversion you may be
familiar with CVS (Concurrent Versions System) and in that case transitioning
to using subversion should be a painless process as the syntax is virtually
identical.

\subsection{Subversion}
\label{sect:subversion}\index{subversion|primary}\index{svn|see{subversion}}

For experienced subversion users, the relevant information that you need to
obtain a copy of fluidity is that it is available from
\lstinline[language=Bash]+http://amcg.ese.ic.ac.uk/svn/fluidity/trunk+ .
For inexperienced users, please read on to learn how to obtain a copy of Fluidity.

As a fluidity user you need only be aware of two modes of operation that
subversion has. The first is checking out a copy of the source code from the
central repository, the second is updating your copy of the code to reflect
changes that have been made to the central repository. Think of the repository
as a central archive of source code held on the main Fluidity servers.

There are a few other useful features for users which subversion has which will
be mentioned in passing.

Details of how to commit changes to Fluidity back into the central repository
are outside the scope of this user manual; if you are transitioning to become a
developer who commits changes back into Fluidity please contact an existing
Fluidity developer to find out how to get commit privileges.

\subsubsection{Checking out a current copy of Fluidity}
\index{subversion}
\label{sect:subversion_checkout_current}

To check out a copy of Fluidity from the central source code repository you
will need the following command, which is given here in entirety but will be
broken down in the subsequent discussion so you can better understand it:

\begin{lstlisting}[language=Bash]
svn co http://amcg.ese.ic.ac.uk/svn/fluidity/trunk/ fluidity/
\end{lstlisting}

The first part of this command calls the svn program:

\begin{lstlisting}[language=Bash]
svn
\end{lstlisting}

svn takes a first argument which describes the mode in which it will run. In
this case, it is going to check out a copy of the code, which abbreviates to
\lstinline[language=Bash]+co+ :

\begin{lstlisting}[language=Bash]
svn co
\end{lstlisting}

The second argument to svn describes the method used to check out Fluidity,
where to find the repository which holds Fluidity, and where in the repository
the up-to-date version of Fluidity is located. In this case, it uses the
hypertext transfer protocol (http) which you will have come across being used
to retrieve web pages, from the server 
\lstinline[language=Bash]+amcg.ese.ic.ac.uk+ on Fluidity is in the directory
\lstinline[language=Bash]+/svn/fluidity/trunk/+ :

\begin{lstlisting}[language=Bash]
svn co http://amcg.ese.ic.ac.uk/svn/fluidity/trunk/
\end{lstlisting}

This is now a valid command line, and if you ran it would check out a copy of
Fluidity into a directory \lstinline[language=Bash]+trunk/+ in your current
directory. If you prefer to have the code checked out into a directory called
\lstinline[language=Bash]+fluidity/+, append that directory name to the end of
the command line so svn checks out the code where you want it to:

\begin{lstlisting}[language=Bash]
svn co http://amcg.ese.ic.ac.uk/svn/fluidity/trunk/ fluidity/
\end{lstlisting}

Bear in mind that the Fluidity check out is of the order of many hundreds of
megabytes and should be checked out onto a filesystem which has corresponding
amounts of free space. As it checks out, subversion should print a lot of file
listing information along the lines of:

\begin{lstlisting}[language=Bash]
A    fluidity/initialisation
\end{lstlisting}

The leading \lstinline[language=Bash]+A+ is svn's way of telling you that it is
is adding files to your local copy of the source code.

\begin{lstlisting}[language=Bash]
Checked out revision 11816.
\end{lstlisting}

The revision number you get will differ from the one quoted here, and is a
specific version (the latest, at the point of checking out) of the Fluidity
code.

\subsubsection{Checking out an older copy of Fluidity}
\label{sect:subversion_checkout_old}

There may be occasions when you want to retrieve a version of fluidity which
isn't the latest one. Perhaps there is active development ongoing and you want
to avoid the possibility of checking out a version which has not been fully
tested, or perhaps you want to retrieve a particular version for the purposes
of benchmarking.

You may either choose to check out a specific revision, or be told a revision
number to check out. To do this, for the example of revision 11816, add in the
argument \lstinline[language=Bash]+-r 11816+ to give:

\begin{lstlisting}[language=Bash]
svn co -r 11816 http://amcg.ese.ic.ac.uk/svn/fluidity/trunk/ fluidity/
\end{lstlisting}

Alternatively, you may either want or be told to check out a specific Fluidity
tag. A tag is a useful method of identifying a particular Fluidity revision
using an easy to remember name, and potentially making further specifications 
of exactly what will be checked out. For example, you may be asked to check out
the \lstinline[language=Bash]+benchmark-9.10+ tag, and to do this you would
change the location within the repository you are checking out from to be
\lstinline[language=Bash]+/svn/fluidity/tags/benchmark-9.10/+ rather than
\lstinline[language=Bash]+/svn/fluidity/trunk/+ . Your svn command would look
like:

\begin{lstlisting}[language=Bash]
svn co http://amcg.ese.ic.ac.uk/svn/fluidity/tags/benchmark-9.10/ fluidity/
\end{lstlisting}

\subsubsection{Updating your copy of Fluidity}
\index{subversion}
\label{sect:subversion_updating}

If you are interested in keeping up to date with the latest developments in
fluidity you will probably want to update your local copy of the Fluidity code
to reflect changes made to the central source code repository. To do this,
change directory so that you are in the directory which you checked out
fluidity to (in the above case, a directory called
\lstinline[language=Bash]+fluidity/+) and then run svn's update command, which
is abbreviated to \lstinline[language=Bash]+up+ as per:

\begin{lstlisting}[language=Bash]
svn up
\end{lstlisting}

You will probably see a number of lines with a leading
\lstinline[language=Bash]+U+, denoting that a file in your local copy of
Fluidity is being updated, such as:

\begin{lstlisting}[language=Bash]
U    preprocessor/Populate_State.F90
\end{lstlisting}

If you have made no changes to your local copy of Fluidity you will rarely have
any problems updating unless a particularly complicated change has been made to
the central source code repository. However, if you have made changes to your
local copy of Fluidity, you may see lines with a leading
\lstinline[language=Bash]+G+, denoting that a locally changed file has had
central repository changes merged into it in a good way:

\begin{lstlisting}[language=Bash]
G    preprocessor/Populate_State.F90
\end{lstlisting}

This is generally the case when you have edited a different part of the file
than has been changed in the central repository. However, if you have edited
the same line as has changed in the central repository you may see a leading
\lstinline[language=Bash]+C+, denoting a conflict between your changes and the
central changes:

\begin{lstlisting}[language=Bash]
C    preprocessor/Populate_State.F90
\end{lstlisting}

At this point you can either discard your local changes by removing the file in
conflict (losing any of your own changes) and running another update to get the
latest version:

\begin{lstlisting}[language=Bash]
rm preprocessor/Populate_State.F90
svn up
\end{lstlisting}

or you can attempt to resolve the conflict. Resolving conflicts between local
and central changes moves you into the realms of becoming a developer and is
outside the scope of this manual, but if you are interested in learning more
about subversion an excellent and comprehensive reference book is freely
available from http://svnbook.red-bean.com/ .

\subsubsection{Other useful subversion commands}
\index{subversion}
\label{sect:subversion_extras}

If you can check out and update your copy of Fluidity then you are equipped to
be an active Fluidity user. However, you may wish to know about a few more
useful subversion commands, including getting information about your local
version of the code using:

\begin{lstlisting}[language=Bash]
svn info
\end{lstlisting}

You may well want to do this if someone asks you which version of Fluidity you
are using, at which point you're looking for a line such as:

\begin{lstlisting}[language=Bash]
Revision: 11816
\end{lstlisting}

with the relevant information.

\section{Building Fluidity}
\label{sect:building_fluidity}

The build process for Fluidity comprises a configuration stage and a compile
stage. In the simplest form, this can be completed with two commands, run in
the directory containing your local source code check out:

\begin{lstlisting}[language=Bash]
./configure
make
\end{lstlisting}

You may often only wish to perform this basic build, but sometimes you will
want more fine-grained control over the configuration procedure or you will
want to perform non-default compilation steps. The following section describes
these procedures.

Note that at this point configuration refers to the build-time configuration
options which define how the Fluidity program will be compiled, and do not
refer to configuation of the options that you will run Fluidity with once it 
has built. However, presence or lack of features configured at the build stage
may change what is available to you at run time.

It is assumed throughout this section that you are in the top-level directory
of your local copy of the Fluidity code for the purposes of describing
configuration and compilation commands.

\subsection{Configuring Fluidity}
\label{sect:configuring_fluidity}

For a full list of the build-time configuration options available in fluidity,
run:

\begin{lstlisting}[language=Bash]
./configure --help
\end{lstlisting}

Key configuration options are described here, but you are advised to check
output from the above command for any changed or new options which may have
been introduced since the last update of this manual.

Where you wish to specify multiple configuration options at once, supply them
all on the same configuration command line, separated by spaces. For example:

\begin{lstlisting}[language=Bash]
./configure --prefix=/data/fluidity --enable-debugging
\end{lstlisting}

\subsubsection{Changing the install location}
\label{sect:configure_change_install_location}

By default if you run the install stage of the fluidity build (detailed in the
following section of the manual), Fluidity will be installed into a set of
directories under the system \lstinline[language=Bash]+/usr/local+ directory.
As a normal UNIX user you are unlikely to have write access to this location,
and unless you intend to make your Fluidity build available to all users of
your computer you almost certainly do not want to install to the default
location.

To change the location into which Fluidity will be installed, use the
\lstinline[language=Bash]+--prefix+ configuration option. For example, to
install files into a directory \lstinline[language=Bash]+/data/fluidity+,
configure fluidity with:

\begin{lstlisting}[language=Bash]
./configure --prefix=/data/fluidity
\end{lstlisting}

If the directory does not exist it will be created, and subdirectories for
binaries, libraries, etc. will be automatically generated.

\subsubsection{Enabling and disabling features}
\label{sect:configure_enable_disable_features}

Fluidity has a number of optional features which may be enabled or disabled at
build time. For a list of all these features see the output of configuring with
the \lstinline[language=Bash]+--help+ argument. This list should indicate which
options are enabled by default by appending
\lstinline[language=Bash]+(default)+ to the option description. An example of
enabling Fluidity's debugging feature at build time would be:

\begin{lstlisting}[language=Bash]
./configure --enable-debugging
\end{lstlisting}

Whilst a number of options have the facility to be enabled and disabled, doing
so may be prejudicial to the expected normal running of Fluidity so unless you
are fully aware of the consequences of enabling or disabling features it is
recommended that you do not do so.

\subsubsection{Specifying locations of supporting libraries}
\label{sect:configure_locate_supporting_libs}

Fluidity requires many supporting libraries, which can either be provided via
environment variables (see later discussion for how to do this) or, in specific
cases, provided via options during configuration. This uses the
\lstinline[language=Bash]+--with+ option, for example specifying the directory
containing BLAS using:

\begin{lstlisting}[language=Bash]
./configure --with-blas-dir=/data/libraries/netlib/BLAS
\end{lstlisting}

Whilst there is also the option to supply \lstinline[language=Bash]+--without+
arguments, this is likely to be highly prejudicial to the normal running of
Fluidity or, in many cases, be incompatible with building Fluidity such that
the configuration exits with an error.

\subsubsection{Environment variables set for configuration}
\label{sect:configure_environment_vars}

A description of environment variables is outside the scope of this manual, and
Fluidity users are encouraged to find an experienced UNIX user who can explain
the rudiments of environment variables to them if they are not alreay familiar
with how to set and use them. Influential environment variables are listed
towards the end of the help output from Fluidity's configuration. Particularly
notable are:

\lstinline[language=Bash]+LIBS+, which allows passing a series of linker
arguments such as \lstinline[language=Bash]+"-L/data/software/libs"+ describing
how to access libraries at link-time. This will often be set or appended to by
loading modules on modern UNIX systems.

\lstinline[language=Bash]+FCFLAGS+ and \lstinline[language=Bash]+FFLAGS+ which
describe flags passed to the Fortran and Fortran77 compilers respectively and
allow you broad control of the overall the build process. This will also often
be set or appended to by loading modules on modern UNIX systems.

\lstinline[language=Bash]+PETSC_DIR+ defines the base directory into which your
PETSc install has been placed. This will often be set by loading an environment
module specific to your system, but if you have a local build of PETSc you may
need to set this variable yourself. Note that for most Fluidity users, having
PETSc to provide solver functionality is unavoidable so setting this variable
by some means is necessary in almost all cases.

\lstinline[language=Bash]+VTK_INCLUDE+ and \lstinline[language=Bash]+VTK_LIBS+
may be important to set if VTK is not installed at a system level. VTK is
critical to Fluidity for writing output files, and many UNIX systems lack some
VTK components so it frequently ends up installed in a nonstandard location.

\subsection{Compiling Fluidity}
\label{sect:compiling_fluidity}

Once you have successfully configured Fluidity, you need to compile the source
code into binary files including programs and libraries. In the simplest form
you can do this by running:

\begin{lstlisting}[language=Bash]
make
\end{lstlisting}

which will generate Fluidity and Diamond programs in the
\lstinline[language=Bash]+bin/+ directory and a set of libraries in the
\lstinline[language=Bash]+lib/+ directory. 

If you want to build the extended set of Fluidity tools which supplement the
main Fluidity program, section \ref{sect:fltools}, run:

\begin{lstlisting}[language=Bash]
make fltools
\end{lstlisting}

If this is the first time you have run fluidity on your computer and you want
to check that it has built correctly, you can run the included suite of test
problems at three levels. The shortest tests test individual units of code for
correctness and can be run with:

\begin{lstlisting}[language=Bash]
make unittest
\end{lstlisting}

To run the suite of short test cases which more extensively test the
functionality of your Fluidity build, run:

\begin{lstlisting}[language=Bash]
make test
\end{lstlisting}

For the most comprehensive set of tests included in your checked out copy of
Fluidity, run:

\begin{lstlisting}[language=Bash]
make mediumtest
\end{lstlisting}

Note that even on the most modern systems
\lstinline[language=Bash]+make mediumtest+ may take on the order of an hour and
on slower systems may take on the order of many hours to complete.

Once you have a known-good build of Fluidity you may want to install it
somewhere other than inside the source check out directory. Assuming you
provided an install prefix at configuration time, running:

\begin{lstlisting}[language=Bash]
make install
\end{lstlisting}

will install all the run-time Fluidity files into the directory you requested
at configure-time.

\section{Running Fluidity}
\label{sect:running_fluidity}


\subsection{Running Fluidity in serial}
\label{sect:running_fluidity_in_serial}

To run \fluidity in serial use the follwoing command:

\begin{lstlisting}[language=bash]
`\fluiditysourcepath'/bin/fluidity -l -v2 my_setup.flml
\end{lstlisting}


\subsection{Running Fluidity in parallel}
\label{sect:running_fluidity_in_parallel}
\index{parallel}

\fluidity\ is a fully-parallel program, capable of running on thousands of processors. 
It uses the Message Passing Interface (MPI) library to communicate information between 
processors. Running \fluidity\ in parallel requires that MPI is available on your system
and is properly configured. This chapter assumes that this is the case. The 
terminology for parallel processing can sometime be confusing. Here, we use the 
term \emph{processor} to mean one physical CPU core and \emph{process} is one part
of a parallel instance of \fluidity. Normally, the number of processors used matches
the number of processes, i.e. if \fluidity\ is split into 256 parts, it is run on 256 processors.

To run in parallel there are no further changes needed, apart from running \fluidity
within the mpirun or mpiexec framework. Simply prepend the normal command line with mpiexec:
\begin{lstlisting}[language=bash]
mpiexec -n [PROCESSES] `\fluiditysourcepath'/bin/fluidity \ 
-l -v2 my_setup.flml
\end{lstlisting}

\subsection{Running a periodic extruded mesh}
\index{parallel!extruded mesh}
%\ref{mesh!extruded}
Running a periodic extruded mesh (section ??) in parallel, requires a number of steps to be taken in order to provide flredecomp (required to make the periodic mesh) with a 2D periodic mesh:

\begin{itemize}
\item Make the periodic 2D flml from the periodic 2plus1 flml
\begin{lstlisting}[language=bash]
 `\fluiditysourcepath'/scripts/make_periodic_2D_flml foo.flml
\end{lstlisting}
\item Periodise the new 2D flml
\begin{lstlisting}[language=bash]
 `\fluiditysourcepath'/periodise foo_2D.flml
\end{lstlisting}
\item Flredecomp the periodised 2D flml
\begin{lstlisting}[language=bash]
mpiexec -n 4 `\fluiditysourcepath'/bin/flredecomp \
    -i 1 -o 4 foo_2D_periodised foo_2D_periodised_flredecomp
\end{lstlisting}
\item Periodise the 2plus1 flml
\begin{lstlisting}[language=bash]
 `\fluiditysourcepath'/periodise foo.flml
\end{lstlisting}
\item Replace the mesh file in foo.flml with the one created in flml\_2D.flml
\item Run the parallel flml as before
\begin{lstlisting}[language=bash]
mpiexec -n [number of processors] \
   `\fluiditysourcepath'/bin/fluidity [options] foo_periodised.flml
\end{lstlisting}
\end{itemize}

There is only one required mesh: the CoordinateMesh. Some settings, fields or other
settings have specific mesh requirements. This are discussed under the appropriate options.

\section{Running diamond}
\label{sect:running_diamond}

If you have run \lstinline[language=Bash]+make+ successfully you will have an
executable program \lstinline[language=Bash]+diamond+ in your
\lstinline[language=Bash]+bin/+ directory. Running diamond is now as simple as
typing:

\begin{lstlisting}[language=Bash]
./bin/diamond
\end{lstlisting}

in the top-level directory of your Fluidity source check-out.

If you ran \lstinline[language=Bash]+make install+ and added the directory
which executable programs were installed into to your
\lstinline[language=Bash]+PATH+ environment variable, you may be able to run
diamond simply by typing \lstinline[language=Bash]+diamond+ at the command line
from any directory on your system. This may also be possible if you have
installed the Diamond package for Ubuntu or Debian by running:

\begin{lstlisting}[language=Bash]
wajig install diamond
\end{lstlisting}

Note that installing Diamond on a system-wide basis with wajig will require you
to have superuser privileges on your system.

\section{Visualising the output}
\label{sect:starting_visualisation}

Once you have built and run Fluidity you will want to visualise the results you
have generated. How to do this is covered in detail in chapter
\ref{chap:visualisation_and_diagnostics}.

\section{Working with the .stat file}
\label{sect:starting_statfile}

As well as visualisation, another important resource which it is worth making
yourself aware of at an early stage is the stat file, described in detail in
section \ref{sect:diagnostics_stat_file}, which contains data from the model
collected at run time.
